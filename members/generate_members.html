<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate Members from Players - GTM</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #ec4899;
    }

    .section h2 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #718096;
      font-weight: 500;
    }

    .info-value {
      color: #2d3748;
      font-weight: 600;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .log {
      background: #1a202c;
      color: #48bb78;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
      line-height: 1.6;
    }

    .log .error {
      color: #fc8181;
    }

    .log .warning {
      color: #f6ad55;
    }

    .log .success {
      color: #68d391;
    }

    .log .info {
      color: #63b3ed;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .membership-config {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .config-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
    }

    .config-item label {
      display: block;
      font-size: 12px;
      color: #718096;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .config-item input,
    .config-item select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé´ Generate Members from Players</h1>
    <p class="subtitle">Automatically create membership records for Klassis and Tauros club players</p>

    <div class="section">
      <h2>Configuration</h2>
      <div class="membership-config">
        <div class="config-item">
          <label>Default Membership Type</label>
          <select id="membershipType">
            <option value="Individual">Individual</option>
            <option value="Family">Family</option>
            <option value="Junior">Junior</option>
            <option value="Senior">Senior</option>
          </select>
        </div>
        <div class="config-item">
          <label>Start Date</label>
          <input type="date" id="startDate" value="2025-01-01">
        </div>
        <div class="config-item">
          <label>Period (months)</label>
          <input type="number" id="periodMonths" value="12" min="1" max="36">
        </div>
        <div class="config-item">
          <label>Status</label>
          <select id="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Statistics</h2>
      <div class="info-row">
        <span class="info-label">Total Players:</span>
        <span class="info-value" id="totalPlayers">0</span>
      </div>
      <div class="info-row">
        <span class="info-label">Klassis Club Players:</span>
        <span class="info-value" id="klassisCount">0</span>
      </div>
      <div class="info-row">
        <span class="info-label">Tauros Club Players:</span>
        <span class="info-value" id="taurosCount">0</span>
      </div>
      <div class="info-row">
        <span class="info-label">Current Members:</span>
        <span class="info-value" id="currentMembers">0</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" onclick="generateMembers()">
        üé´ Generate Members
      </button>
      <button class="btn btn-success" onclick="syncToFirebase()">
        ‚òÅÔ∏è Sync to Firebase
      </button>
      <button class="btn btn-secondary" onclick="clearLog()">
        üóëÔ∏è Clear Log
      </button>
      <button class="btn btn-secondary" onclick="viewMembers()">
        üë• View Members
      </button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // Import Firebase config
    let firebaseConfig;
    try {
      const configModule = await import('../firebase-config.js');
      firebaseConfig = configModule.default || configModule.firebaseConfig;
    } catch (error) {
      console.error('Error loading Firebase config:', error);
    }

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    window.db = database;
    window.auth = auth;

    // Initialize
    loadStatistics();
  </script>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function loadStatistics() {
      const players = JSON.parse(localStorage.getItem('players') || '[]');
      const members = JSON.parse(localStorage.getItem('members') || '[]');

      const klassisPlayers = players.filter(p => 
        p.club && (p.club.toLowerCase().includes('klassis') || p.club.toLowerCase() === 'klassis')
      );
      const taurosPlayers = players.filter(p => 
        p.club && (p.club.toLowerCase().includes('tauros') || p.club.toLowerCase() === 'tauros')
      );

      document.getElementById('totalPlayers').textContent = players.length;
      document.getElementById('klassisCount').textContent = klassisPlayers.length;
      document.getElementById('taurosCount').textContent = taurosPlayers.length;
      document.getElementById('currentMembers').textContent = members.length;

      log(`Loaded ${players.length} players, ${members.length} existing members`, 'info');
    }

    function generateMemberId(club, index) {
      const clubCode = club.toLowerCase().includes('klassis') ? 'KLS' : 
                       club.toLowerCase().includes('tauros') ? 'TAU' : 'GTM';
      const year = new Date().getFullYear().toString().substr(-2);
      const num = String(index + 1).padStart(4, '0');
      return `${clubCode}${year}${num}`;
    }

    function calculateExpiryDate(startDate, months) {
      const date = new Date(startDate);
      date.setMonth(date.getMonth() + months);
      return date.toISOString().split('T')[0];
    }

    function generateMembers() {
      log('=== Starting Member Generation ===', 'info');
      
      const players = JSON.parse(localStorage.getItem('players') || '[]');
      const existingMembers = JSON.parse(localStorage.getItem('members') || '[]');
      
      const membershipType = document.getElementById('membershipType').value;
      const startDate = document.getElementById('startDate').value;
      const periodMonths = parseInt(document.getElementById('periodMonths').value);
      const status = document.getElementById('status').value;
      
      log(`Config: Type=${membershipType}, Start=${startDate}, Period=${periodMonths}mo, Status=${status}`, 'info');

      // Filter players from Klassis and Tauros
      const targetPlayers = players.filter(p => {
        if (!p.club) return false;
        const clubLower = p.club.toLowerCase();
        return clubLower.includes('klassis') || clubLower.includes('tauros');
      });

      log(`Found ${targetPlayers.length} players from Klassis and Tauros clubs`, 'success');

      const newMembers = [];
      let klassisIndex = 0;
      let taurosIndex = 0;

      targetPlayers.forEach((player, index) => {
        // Check if member already exists for this player
        const existingMember = existingMembers.find(m => m.playerRegNo === player.regNo);
        if (existingMember) {
          log(`‚ö†Ô∏è Skipping ${player.firstName} ${player.lastName} (${player.regNo}) - already has membership`, 'warning');
          return;
        }

        const isKlassis = player.club.toLowerCase().includes('klassis');
        const clubName = isKlassis ? 'Klassis Golf Club' : 'Tauros Golf Club';
        const clubId = isKlassis ? 'klassis' : 'tauros';
        
        const memberIndex = isKlassis ? klassisIndex++ : taurosIndex++;
        const memberId = generateMemberId(player.club, memberIndex);
        const expiryDate = calculateExpiryDate(startDate, periodMonths);

        const member = {
          memberId: memberId,
          playerRegNo: player.regNo || '',
          firstName: player.firstName || '',
          lastName: player.lastName || '',
          email: player.email || '',
          mobile: player.mobile || '',
          membershipType: membershipType,
          status: status,
          joinDate: startDate,
          startDate: startDate,
          expiryDate: expiryDate,
          clubId: clubId,
          clubName: clubName,
          createdAt: new Date().toISOString(),
          createdBy: 'auto-generator'
        };

        newMembers.push(member);
        log(`‚úì Created member ${memberId} for ${player.firstName} ${player.lastName} (${clubName})`, 'success');
      });

      if (newMembers.length === 0) {
        log('No new members to create (all players already have memberships)', 'warning');
        return;
      }

      // Combine with existing members
      const allMembers = [...existingMembers, ...newMembers];
      
      // Save to localStorage
      localStorage.setItem('members', JSON.stringify(allMembers));
      
      log(`=== Generation Complete ===`, 'success');
      log(`Created ${newMembers.length} new members`, 'success');
      log(`Total members: ${allMembers.length}`, 'info');
      
      // Reload statistics
      loadStatistics();
    }

    async function syncToFirebase() {
      log('=== Starting Firebase Sync ===', 'info');
      
      const members = JSON.parse(localStorage.getItem('members') || '[]');
      
      if (members.length === 0) {
        log('No members to sync', 'warning');
        return;
      }

      try {
        const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js');
        
        let synced = 0;
        for (const member of members) {
          const memberRef = ref(window.db, `members/${member.memberId}`);
          await set(memberRef, member);
          synced++;
          log(`‚òÅÔ∏è Synced ${member.memberId} - ${member.firstName} ${member.lastName}`, 'info');
        }
        
        log(`=== Sync Complete ===`, 'success');
        log(`Synced ${synced} members to Firebase`, 'success');
        
      } catch (error) {
        log(`‚ùå Error syncing to Firebase: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function viewMembers() {
      window.location.href = '/members/index.html';
    }
  </script>
</body>
</html>
