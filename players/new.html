<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Create Player</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../components/auth.js"></script>
    
    <link rel="stylesheet" href="../styles.css">
    <style>
      .form-card{max-width:720px;margin:28px auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
      .form-row{display:flex;gap:12px}
      .form-row .col{flex:1}
      .field{display:flex;flex-direction:column;margin-bottom:12px}
      label{font-weight:600;margin-bottom:6px}
      input,select{padding:10px;border-radius:8px;border:1px solid #e6e9ef}
      .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    </style>
  </head>
  <body>
    <div class="top-nav">
      <h1>üèåÔ∏è Create Player</h1>
      <a href="index.html" class="btn-back-top">‚Üê Back</a>
    </div>
    <main>
      <div class="form-card">
        <form id="create-player-form">
          <div id="form-messages" style="margin-bottom:12px"></div>
          <div class="field">
            <label for="reg">Reg No</label>
            <input id="reg" name="reg" readonly />
          </div>
          <!-- Duplicate check modal -->
          <div id="dupe-modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:60">
            <div style="background:#fff;border-radius:10px;max-width:720px;width:92%;padding:16px;margin:auto;box-shadow:0 12px 40px rgba(2,6,23,0.5)">
              <h3 style="margin-top:0">Possible existing player(s) found</h3>
              <p style="color:#334155">Please check if one of these records is the same person. If it is, cancel registration.</p>
              <div id="dupe-list" style="max-height:260px;overflow:auto;margin:8px 0;padding:6px;border:1px solid #e6e9ef;border-radius:6px"></div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
                <button id="dupe-not" type="button" class="big-btn" style="background:#fff;border:1px solid #cbd5e1;color:#0f172a">This is not him/her</button>
                <button id="dupe-yes" type="button" class="big-btn" style="background:#ef4444;border:0;color:#fff">Yes - This is him/her</button>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="firstName">Player Name</label>
              <input id="firstName" name="firstName" required />
            </div>
            <div class="col field">
              <label for="lastName">Last Name</label>
              <input id="lastName" name="lastName" required />
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="homeClub">Home club</label>
              <input id="homeClub" name="homeClub" readonly />
            </div>
            <div class="col field">
              <label for="hcp">Handicap</label>
              <input id="hcp" name="hcp" type="number" step="0.1" placeholder="e.g. 12.4" />
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="dob">Date of Birth</label>
              <input id="dob" name="dob" type="date" required />
            </div>
            <div class="col field">
              <label for="ageGroup">Age Group</label>
              <input id="ageGroup" name="ageGroup" readonly style="background-color: #f1f5f9; cursor: not-allowed;" />
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="gender">Gender</label>
              <select id="gender" name="gender" required>
                <option value="">Select</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col field">
              <!-- Empty space for layout balance -->
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="nationality">Nationality</label>
              <select id="nationality" name="nationality" required>
                <option value="">Select Country</option>
                <option value="Afghanistan">Afghanistan</option>
                <option value="Albania">Albania</option>
                <option value="Algeria">Algeria</option>
                <option value="Andorra">Andorra</option>
                <option value="Angola">Angola</option>
                <option value="Argentina">Argentina</option>
                <option value="Armenia">Armenia</option>
                <option value="Australia">Australia</option>
                <option value="Austria">Austria</option>
                <option value="Azerbaijan">Azerbaijan</option>
                <option value="Bahamas">Bahamas</option>
                <option value="Bahrain">Bahrain</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Barbados">Barbados</option>
                <option value="Belarus">Belarus</option>
                <option value="Belgium">Belgium</option>
                <option value="Belize">Belize</option>
                <option value="Benin">Benin</option>
                <option value="Bhutan">Bhutan</option>
                <option value="Bolivia">Bolivia</option>
                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                <option value="Botswana">Botswana</option>
                <option value="Brazil">Brazil</option>
                <option value="Brunei">Brunei</option>
                <option value="Bulgaria">Bulgaria</option>
                <option value="Burkina Faso">Burkina Faso</option>
                <option value="Burundi">Burundi</option>
                <option value="Cambodia">Cambodia</option>
                <option value="Cameroon">Cameroon</option>
                <option value="Canada">Canada</option>
                <option value="Cape Verde">Cape Verde</option>
                <option value="Central African Republic">Central African Republic</option>
                <option value="Chad">Chad</option>
                <option value="Chile">Chile</option>
                <option value="China">China</option>
                <option value="Colombia">Colombia</option>
                <option value="Comoros">Comoros</option>
                <option value="Congo">Congo</option>
                <option value="Costa Rica">Costa Rica</option>
                <option value="Croatia">Croatia</option>
                <option value="Cuba">Cuba</option>
                <option value="Cyprus">Cyprus</option>
                <option value="Czech Republic">Czech Republic</option>
                <option value="Denmark">Denmark</option>
                <option value="Djibouti">Djibouti</option>
                <option value="Dominica">Dominica</option>
                <option value="Dominican Republic">Dominican Republic</option>
                <option value="Ecuador">Ecuador</option>
                <option value="Egypt">Egypt</option>
                <option value="El Salvador">El Salvador</option>
                <option value="Equatorial Guinea">Equatorial Guinea</option>
                <option value="Eritrea">Eritrea</option>
                <option value="Estonia">Estonia</option>
                <option value="Ethiopia">Ethiopia</option>
                <option value="Fiji">Fiji</option>
                <option value="Finland">Finland</option>
                <option value="France">France</option>
                <option value="Gabon">Gabon</option>
                <option value="Gambia">Gambia</option>
                <option value="Georgia">Georgia</option>
                <option value="Germany">Germany</option>
                <option value="Ghana">Ghana</option>
                <option value="Greece">Greece</option>
                <option value="Grenada">Grenada</option>
                <option value="Guatemala">Guatemala</option>
                <option value="Guinea">Guinea</option>
                <option value="Guinea-Bissau">Guinea-Bissau</option>
                <option value="Guyana">Guyana</option>
                <option value="Haiti">Haiti</option>
                <option value="Honduras">Honduras</option>
                <option value="Hungary">Hungary</option>
                <option value="Iceland">Iceland</option>
                <option value="India">India</option>
                <option value="Indonesia">Indonesia</option>
                <option value="Iran">Iran</option>
                <option value="Iraq">Iraq</option>
                <option value="Ireland">Ireland</option>
                <option value="Israel">Israel</option>
                <option value="Italy">Italy</option>
                <option value="Jamaica">Jamaica</option>
                <option value="Japan">Japan</option>
                <option value="Jordan">Jordan</option>
                <option value="Kazakhstan">Kazakhstan</option>
                <option value="Kenya">Kenya</option>
                <option value="Kiribati">Kiribati</option>
                <option value="Korea, North">Korea, North</option>
                <option value="Korea, South">Korea, South</option>
                <option value="Kuwait">Kuwait</option>
                <option value="Kyrgyzstan">Kyrgyzstan</option>
                <option value="Laos">Laos</option>
                <option value="Latvia">Latvia</option>
                <option value="Lebanon">Lebanon</option>
                <option value="Lesotho">Lesotho</option>
                <option value="Liberia">Liberia</option>
                <option value="Libya">Libya</option>
                <option value="Liechtenstein">Liechtenstein</option>
                <option value="Lithuania">Lithuania</option>
                <option value="Luxembourg">Luxembourg</option>
                <option value="Madagascar">Madagascar</option>
                <option value="Malawi">Malawi</option>
                <option value="Malaysia">Malaysia</option>
                <option value="Maldives">Maldives</option>
                <option value="Mali">Mali</option>
                <option value="Malta">Malta</option>
                <option value="Marshall Islands">Marshall Islands</option>
                <option value="Mauritania">Mauritania</option>
                <option value="Mauritius">Mauritius</option>
                <option value="Mexico">Mexico</option>
                <option value="Micronesia">Micronesia</option>
                <option value="Moldova">Moldova</option>
                <option value="Monaco">Monaco</option>
                <option value="Mongolia">Mongolia</option>
                <option value="Montenegro">Montenegro</option>
                <option value="Morocco">Morocco</option>
                <option value="Mozambique">Mozambique</option>
                <option value="Myanmar">Myanmar</option>
                <option value="Namibia">Namibia</option>
                <option value="Nauru">Nauru</option>
                <option value="Nepal">Nepal</option>
                <option value="Netherlands">Netherlands</option>
                <option value="New Zealand">New Zealand</option>
                <option value="Nicaragua">Nicaragua</option>
                <option value="Niger">Niger</option>
                <option value="Nigeria">Nigeria</option>
                <option value="North Macedonia">North Macedonia</option>
                <option value="Norway">Norway</option>
                <option value="Oman">Oman</option>
                <option value="Pakistan">Pakistan</option>
                <option value="Palau">Palau</option>
                <option value="Palestine">Palestine</option>
                <option value="Panama">Panama</option>
                <option value="Papua New Guinea">Papua New Guinea</option>
                <option value="Paraguay">Paraguay</option>
                <option value="Peru">Peru</option>
                <option value="Philippines">Philippines</option>
                <option value="Poland">Poland</option>
                <option value="Portugal">Portugal</option>
                <option value="Qatar">Qatar</option>
                <option value="Romania">Romania</option>
                <option value="Russia">Russia</option>
                <option value="Rwanda">Rwanda</option>
                <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                <option value="Saint Lucia">Saint Lucia</option>
                <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
                <option value="Samoa">Samoa</option>
                <option value="San Marino">San Marino</option>
                <option value="Sao Tome and Principe">Sao Tome and Principe</option>
                <option value="Saudi Arabia">Saudi Arabia</option>
                <option value="Senegal">Senegal</option>
                <option value="Serbia">Serbia</option>
                <option value="Seychelles">Seychelles</option>
                <option value="Sierra Leone">Sierra Leone</option>
                <option value="Singapore">Singapore</option>
                <option value="Slovakia">Slovakia</option>
                <option value="Slovenia">Slovenia</option>
                <option value="Solomon Islands">Solomon Islands</option>
                <option value="Somalia">Somalia</option>
                <option value="South Africa">South Africa</option>
                <option value="South Sudan">South Sudan</option>
                <option value="Spain">Spain</option>
                <option value="Sri Lanka">Sri Lanka</option>
                <option value="Sudan">Sudan</option>
                <option value="Suriname">Suriname</option>
                <option value="Sweden">Sweden</option>
                <option value="Switzerland">Switzerland</option>
                <option value="Syria">Syria</option>
                <option value="Taiwan">Taiwan</option>
                <option value="Tajikistan">Tajikistan</option>
                <option value="Tanzania">Tanzania</option>
                <option value="Thailand">Thailand</option>
                <option value="Timor-Leste">Timor-Leste</option>
                <option value="Togo">Togo</option>
                <option value="Tonga">Tonga</option>
                <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                <option value="Tunisia">Tunisia</option>
                <option value="Turkey">Turkey</option>
                <option value="Turkmenistan">Turkmenistan</option>
                <option value="Tuvalu">Tuvalu</option>
                <option value="Uganda">Uganda</option>
                <option value="Ukraine">Ukraine</option>
                <option value="United Arab Emirates">United Arab Emirates</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="United States">United States</option>
                <option value="Uruguay">Uruguay</option>
                <option value="Uzbekistan">Uzbekistan</option>
                <option value="Vanuatu">Vanuatu</option>
                <option value="Vatican City">Vatican City</option>
                <option value="Venezuela">Venezuela</option>
                <option value="Vietnam">Vietnam</option>
                <option value="Yemen">Yemen</option>
                <option value="Zambia">Zambia</option>
                <option value="Zimbabwe">Zimbabwe</option>
              </select>
            </div>
            <div class="col field">
              <label for="playerType">Player Type</label>
              <select id="playerType" name="playerType" required>
                <option value="">Select</option>
                <option value="amateur">Amateur</option>
                <option value="professional">Professional</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="admissionDate">Admission Date</label>
              <input id="admissionDate" name="admissionDate" type="date" readonly />
            </div>
            <div class="col field">
              <label for="idNo">ID No</label>
              <input id="idNo" name="idNo" inputmode="numeric" maxlength="11" placeholder="11 digits" autocomplete="off" required />
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="email">E-mail</label>
              <input id="email" name="email" type="email" autocomplete="off" required />
            </div>
          </div>

          <style>
            .mobile-section{margin-bottom:12px}
            .mobile-title{font-size:16px;font-weight:700;margin-bottom:6px}
            .mobile-sub{font-size:12px;color:#64748b;margin-bottom:8px}
            .mobile-group{display:flex;gap:8px;align-items:center}
            .country-select{width:90px;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
            .mobile-input{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ef}
          </style>

          <div class="mobile-section">
            <div class="mobile-title">Mobile</div>
            <div class="mobile-sub">Country code</div>
            <div class="mobile-group">
              <select id="countryCode" name="countryCode" class="country-select" required>
                <option value="+90">TUR (+90)</option>
                <option value="+1">USA (+1)</option>
                <option value="+44">UK (+44)</option>
                <option value="+61">AUS (+61)</option>
                <option value="+49">DEU (+49)</option>
              </select>
              <input id="mobileNumber" name="mobileNumber" class="mobile-input" inputmode="numeric" placeholder="5xx xxx xxxx" required />
            </div>
          </div>

          <div class="form-row">
            <div class="col field">
              <label for="address">Address (optional)</label>
              <input id="address" name="address" />
            </div>
          </div>

          <div class="actions">
            <button type="button" id="cancel" class="big-btn">Cancel</button>
            <button type="submit" id="submit-btn" class="big-btn">Create</button>
          </div>
        </form>
      </div>
    </main>

    <script>
      function getPlayers(){ try{ const raw = localStorage.getItem('players'); return raw?JSON.parse(raw):[] }catch(e){return[]} }
      
      function savePlayers(list){
        try{
          const prev = localStorage.getItem('players');
          if(prev) localStorage.setItem('players_backup', prev);
          localStorage.setItem('players', JSON.stringify(list||[]));
          localStorage.setItem('players_backup_ts', new Date().toISOString());
          // Sync to Firebase - convert array to object keyed by reg no
          if (typeof syncToFirebase !== 'undefined') {
            const playersObj = {};
            (list || []).forEach(player => {
              if (player && player.reg) {
                playersObj[player.reg] = player;
              }
            });
            syncToFirebase('players', playersObj);
          }
        }catch(e){ console.error('savePlayers error', e); }
      }
      
      function getCurrentUser(){ try{ const raw = localStorage.getItem('currentUser'); return raw?JSON.parse(raw):{id:'main',name:'Main Admin',role:'admin'}}catch(e){return {id:'main',name:'Main Admin',role:'admin'}} }

      function padNum(n, width=3){ const s = String(n); return s.padStart(width, '0'); }

      function nextReg(){
        const list = getPlayers();
        let max = 0; 
        list.forEach(p=>{ 
          const reg = (p.reg||'').replace(/^P/i, '').replace(/^0+/,'');
          const v = parseInt(reg)||0; 
          if(v>max) max=v;
        });
        return 'P' + padNum(max+1, 4);
      }

      // Calculate age as of January 1st of current year
      function calculateAgeAsOfJan1(dob) {
        if (!dob) return null;
        const birthDate = new Date(dob);
        const currentYear = new Date().getFullYear();
        const jan1 = new Date(currentYear, 0, 1);
        let age = jan1.getFullYear() - birthDate.getFullYear();
        return age;
      }

      // Get age group based on age and preferences
      function getAgeGroup(age) {
        if (age === null || age === undefined) return '';
        
        try {
          const prefsRaw = localStorage.getItem('preferences');
          if (!prefsRaw) return '';
          
          const prefs = JSON.parse(prefsRaw);
          const ageGroups = prefs.ageGroups || [];
          
          for (let group of ageGroups) {
            if (age >= group.minAge && age <= group.maxAge) {
              return group.name;
            }
          }
        } catch(e) {
          console.error('Error getting age group:', e);
        }
        
        return '';
      }

      // Update age group when DOB changes
      function updateAgeGroup() {
        const dobEl = document.getElementById('dob');
        const ageGroupEl = document.getElementById('ageGroup');
        
        if (dobEl.value) {
          const age = calculateAgeAsOfJan1(dobEl.value);
          const ageGroup = getAgeGroup(age);
          ageGroupEl.value = ageGroup;
        } else {
          ageGroupEl.value = '';
        }
      }

      // initialize
      document.addEventListener('DOMContentLoaded', async ()=>{
        const regEl = document.getElementById('reg');
        const homeClubEl = document.getElementById('homeClub');
        
        // Get user profile from Firebase Auth/Firestore
        let clubName = 'Main Admin';
        try {
          // Wait for Auth module to be available
          let attempts = 0;
          while (typeof window.Auth === 'undefined' && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
          
          if (typeof window.Auth !== 'undefined') {
            // Wait a bit for auth state to be ready
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const profile = await window.Auth.getUserProfile();
            const role = await window.Auth.getUserRole();
            console.log('User profile loaded:', profile, 'Role:', role);
            
            if (profile) {
              // Use displayName (e.g., "Klassis Golf Club") or loginName (e.g., "klassis")
              clubName = profile.displayName || profile.loginName || 'Club';
            } else if (role === 'admin') {
              clubName = 'Main Admin';
            }
          } else {
            console.warn('Auth module not available, using fallback');
          }
        } catch(e) {
          console.error('Error loading user profile:', e);
          // Fallback to localStorage method
          const cur = getCurrentUser();
          clubName = cur.name;
          if(cur.name && cur.name.includes(':')) clubName = cur.name.split(':').pop().trim();
        }
        
        homeClubEl.value = clubName;
        
        // Set admission date to today for new players
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('admissionDate').value = today;

        // detect edit mode via query param ?edit=<index>
        const params = new URLSearchParams(window.location.search);
        const editParam = params.get('edit');
        let editIndex = null;
        let editMode = false;
        if(editParam !== null){
          const i = parseInt(editParam,10);
          console.log('Edit param:', editParam, 'Parsed index:', i);
          if(!isNaN(i)){
            const players = getPlayers();
            console.log('All players:', players.length, 'Looking for index:', i);
            if(players && players[i]){
              editIndex = i; editMode = true;
              console.log('‚úì Edit mode enabled for player:', players[i]);
            } else {
              console.error('Player not found at index:', i);
              alert('Player not found. Returning to players list.');
              window.location.href = 'index.html';
              return;
            }
          }
        }

        if(editMode){
          // populate form with existing player
          const players = getPlayers();
          const p = players[editIndex];
          console.log('Edit mode - Loading player:', p);
          const titleEl = document.querySelector('.top-nav h1');
          if (titleEl) titleEl.textContent = 'üèåÔ∏è Modify Player';
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) submitBtn.textContent = 'Save Changes';
          regEl.value = p.reg || nextReg();
          document.getElementById('firstName').value = p.firstName || '';
          document.getElementById('lastName').value = p.lastName || '';
          homeClubEl.value = p.homeClub || p.club || '';
          
          // Allow home club editing only for admin users
          try {
            const userRole = await window.Auth.getUserRole();
            homeClubEl.readOnly = (userRole !== 'admin');
          } catch(e) {
            // If Auth fails, keep it readonly for safety
            homeClubEl.readOnly = true;
          }
          
          document.getElementById('dob').value = p.dob || '';
          updateAgeGroup(); // Calculate age group from DOB
          document.getElementById('gender').value = p.gender || '';
          document.getElementById('nationality').value = p.nationality || '';
          document.getElementById('playerType').value = p.playerType || '';
          document.getElementById('admissionDate').value = p.admissionDate || today;
          document.getElementById('hcp').value = p.hcp || '';
          document.getElementById('idNo').value = p.idNo || '';
          // Allow ID edit but it will still check for duplicates
          document.getElementById('email').value = p.email || '';
          // mobile: split country code and raw digits if available
          if(p.mobileRaw){
            // try to detect country code from p.mobile if present
            if(p.mobile && p.mobile.indexOf(' ')>0){
              const parts = p.mobile.split(' ');
              const code = parts[0];
              const idx = Array.from(document.getElementById('countryCode').options).find(o=>o.value===code);
              if(idx) document.getElementById('countryCode').value = code;
            }
            document.getElementById('mobileNumber').value = formatPhoneDigits(p.mobileRaw);
          } else if(p.mobile){
            // fallback: attempt to extract digits
            const raw = p.mobile.replace(/\D/g,'');
            document.getElementById('mobileNumber').value = formatPhoneDigits(raw);
          }
          document.getElementById('address').value = p.address || '';
        } else {
          regEl.value = nextReg();
        }

        document.getElementById('cancel').addEventListener('click', ()=>{ window.location.href = 'index.html' });

        // Add DOB change listener to auto-update age group
        document.getElementById('dob').addEventListener('change', updateAgeGroup);

        const mobileEl = document.getElementById('mobileNumber');
        const countryEl = document.getElementById('countryCode');

        function formatPhoneDigits(digits){
          // format as 3-3-4 (e.g. 5xx xxx xxxx) when possible
          if(!digits) return '';
          const d = digits.replace(/\D/g,'');
          if(d.length <= 3) return d;
          if(d.length <= 6) return d.slice(0,3) + ' ' + d.slice(3);
          return d.slice(0,3) + ' ' + d.slice(3,6) + ' ' + d.slice(6,10);
        }

        // enforce digits-only and format display while typing
        mobileEl.addEventListener('input', (ev)=>{
          const raw = mobileEl.value.replace(/\D/g,'');
          const formatted = formatPhoneDigits(raw);
          mobileEl.value = formatted;
        });

        // ID No: digits only
        const idEl = document.getElementById('idNo');
        idEl.addEventListener('input', ()=>{ idEl.value = idEl.value.replace(/\D/g,'').slice(0,11) });

        // Duplicate-name modal elements
        const dupeModal = document.getElementById('dupe-modal');
        const dupeList = document.getElementById('dupe-list');
        const dupeNot = document.getElementById('dupe-not');
        const dupeYes = document.getElementById('dupe-yes');

        function closeDupeModal(){ dupeModal.style.display='none'; dupeList.innerHTML=''; }

        function showDupeModal(matches){
          dupeList.innerHTML = '';
          matches.forEach(m=>{
            const div = document.createElement('div');
            div.style.padding='8px'; div.style.borderBottom='1px solid #eef2ff';
            div.innerHTML = `<strong>Reg:</strong> ${escapeHtml(m.reg||'')} &nbsp; <strong>Name:</strong> ${escapeHtml(((m.firstName||'')+' '+(m.lastName||'')).trim())} <br><strong>ID:</strong> ${escapeHtml(m.idNo||'')} &nbsp; <strong>Mobile:</strong> ${escapeHtml(m.mobile||'')}`;
            dupeList.appendChild(div);
          });
          dupeModal.style.display='flex';
        }

        // When user confirms 'Yes this is him/her' -> cancel registration (redirect to players list)
        dupeYes.addEventListener('click', ()=>{
          closeDupeModal();
          showMessage('success','Existing player selected. Redirecting to players list...');
          setTimeout(()=>{ window.location.href = 'index.html' }, 700);
        });

        // When user clicks 'This is not him/her' -> close modal and let them continue
        dupeNot.addEventListener('click', ()=>{ closeDupeModal(); dupeConfirmed = true; document.getElementById('firstName').focus(); });

        let dupeConfirmed = false;
        // perform duplicate-name check (called after entering first+last name)
        function checkNameDuplicates(){
          if(editMode) return false; // don't check in edit mode
          clearMessages();
          const f = (document.getElementById('firstName').value||'').trim().toLowerCase();
          const l = (document.getElementById('lastName').value||'').trim().toLowerCase();
          console.log('Checking for duplicates:', f, l);
          if(!f || !l) return false;
          const players = getPlayers();
          const matches = [];
          for(let i=0;i<players.length;i++){
            const p = players[i];
            const pFirst = (p.firstName||'').toLowerCase();
            const pLast = (p.lastName||'').toLowerCase();
            const pTokens = ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase().split(/\s+/).filter(Boolean);
            const newTokens = (f + ' ' + l).toLowerCase().split(/\s+/).filter(Boolean);
            // require last name match and some token overlap
            if(pLast && l && pLast === l){
              const intersection = pTokens.filter(t=> newTokens.includes(t));
              if(intersection.length>0 || pTokens.join(' ').includes(newTokens.join(' ')) || newTokens.join(' ').includes(pTokens.join(' '))){
                matches.push(p);
              }
            }
          }
          console.log('Duplicate matches found:', matches);
          if(matches.length>0 && !dupeConfirmed) {
            showDupeModal(matches);
            return true; // found matches, modal shown
          }
          return false; // no matches or already confirmed
        }

        dupeNot.addEventListener('click', ()=>{ closeDupeModal(); dupeConfirmed = true; document.getElementById('firstName').focus(); });

        // trigger duplicate check after user leaves name fields or types
        let dupeCheckTimeout = null;
        function scheduleDupeCheck(){
          clearTimeout(dupeCheckTimeout);
          dupeCheckTimeout = setTimeout(checkNameDuplicates, 250);
        }
        document.getElementById('firstName').removeEventListener('input', scheduleDupeCheck);
        document.getElementById('lastName').removeEventListener('input', scheduleDupeCheck);
        document.getElementById('firstName').addEventListener('blur', function(){ /* no-op */ });
        document.getElementById('lastName').addEventListener('blur', checkNameDuplicates);

        // Inline message helpers
        const msgContainer = document.getElementById('form-messages');
        function clearMessages(){ msgContainer.innerHTML = '' }
        function showMessage(type, text){
          clearMessages();
          const d = document.createElement('div');
          d.textContent = text;
          d.style.padding = '10px';
          d.style.borderRadius = '6px';
          d.style.marginBottom = '6px';
          if(type==='error'){ d.style.background = '#fee2e2'; d.style.color = '#991b1b'; d.style.border = '1px solid #fecaca' }
          else if(type==='warning'){ d.style.background = '#fff7ed'; d.style.color = '#92400e'; d.style.border = '1px solid #ffd8a8' }
          else if(type==='success'){ d.style.background = '#ecfccb'; d.style.color = '#365314'; d.style.border = '1px solid #bbf7d0' }
          msgContainer.appendChild(d);
        }

        // allow pasting digits-only
        mobileEl.addEventListener('paste', (ev)=>{
          ev.preventDefault();
          const text = (ev.clipboardData || window.clipboardData).getData('text') || '';
          const digits = text.replace(/\D/g,'');
          mobileEl.value = formatPhoneDigits(digits);
        });

        document.getElementById('create-player-form').addEventListener('submit', (e)=>{
          e.preventDefault();
          // If duplicate modal should show, block submit
          if(checkNameDuplicates()) return;
          const countryCode = countryEl.value;
            const mobileFormatted = mobileEl.value.trim();
            const mobileRaw = mobileFormatted.replace(/\D/g,'');

            // per-country expected lengths (number of digits without country code)
            const countryLengths = {
              '+90': 10, // Turkey
              '+1': 10,  // USA/Canada
              '+44': 10, // UK (common mobile length)
              '+61': 9,  // Australia (mobile w/o leading 0 often 9)
              '+49': 11  // Germany (varies, using 11 as common)
            };
            const expected = countryLengths[countryCode];

          // normalize names: capitalize first letter of each word
          function capitalizeWords(s){ return s.split(/\s+/).filter(Boolean).map(w=> w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') }
          const firstRaw = document.getElementById('firstName').value.trim();
          const lastRaw = document.getElementById('lastName').value.trim();
          const first = capitalizeWords(firstRaw);
          const last = capitalizeWords(lastRaw);
          const hcpValue = document.getElementById('hcp').value.trim();
          const dob = document.getElementById('dob').value;
          const age = calculateAgeAsOfJan1(dob);
          const ageGroup = getAgeGroup(age);
          
          const data = {
            reg: document.getElementById('reg').value.trim(),
            firstName: first,
            lastName: last,
            name: (first + ' ' + last).trim(),
            homeClub: document.getElementById('homeClub').value.trim(),
            club: document.getElementById('homeClub').value.trim(),
            hcp: hcpValue ? parseFloat(hcpValue) : undefined,
            dob: dob,
            age: age,
            ageGroup: ageGroup,
            gender: document.getElementById('gender').value,
            nationality: document.getElementById('nationality').value,
            playerType: document.getElementById('playerType').value,
            admissionDate: document.getElementById('admissionDate').value,
            idNo: document.getElementById('idNo').value.trim(),
            email: document.getElementById('email').value.trim(),
            mobile: countryCode + ' ' + mobileFormatted,
            mobileRaw: mobileRaw,
            address: document.getElementById('address').value.trim()
          };

          // validate required
          const required = ['reg','firstName','lastName','club','dob','gender','nationality','playerType','idNo','email'];
          // mobile handled separately
          if(!mobileRaw || mobileRaw.length < 7){ showMessage('error','Please enter a valid mobile number (digits only)'); return }
          if(expected){
            if(mobileRaw.length !== expected){
              showMessage('error','Mobile number should be ' + expected + ' digits for ' + countryEl.options[countryEl.selectedIndex].text);
              return;
            }
          } else {
            // when country not in mapping, require at least 7 and at most 15 digits
            if(mobileRaw.length < 7 || mobileRaw.length > 15){ showMessage('error','Please enter a valid mobile number (7-15 digits)'); return }
          }
          for(const k of required){ if(!data[k] || data[k].length===0){ showMessage('error','Please fill: '+k); return } }
          // ID No exact length
          if(!/^[0-9]{11}$/.test(data.idNo)){ showMessage('error','ID No must be exactly 11 digits'); return }

          // simple email check
          const emailRe = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
          if(!emailRe.test(data.email)){ showMessage('error','Please enter a valid email'); return }

          // duplicate ID check (blocking)
          const players = getPlayers();
          const curUser = getCurrentUser();
          const duplicateById = players.find((p,idx)=> p.idNo === data.idNo && (!editMode || idx !== editIndex));
          if(duplicateById){ showMessage('error','A player with this ID No already exists (Reg: ' + (duplicateById.reg||'') + ').'); return }

          // name-similarity check is now handled by modal, so skip warning
          if(editMode && editIndex!==null){
            // overwrite existing
            const existing = players[editIndex] || {};
            players[editIndex] = Object.assign(existing, Object.assign({ owner: existing.owner || curUser.id }, data));
            savePlayers(players);
            showMessage('success','Player updated');
            dupeConfirmed = false;
            setTimeout(()=>{ window.location.href = 'index.html' }, 700);
          } else {
            players.push(Object.assign({ owner: curUser.id, importedBy: [] }, data));
            savePlayers(players);
            showMessage('success','Player created');
            dupeConfirmed = false;
            setTimeout(()=>{ window.location.href = 'index.html' }, 700);
          }
        });
      });
    </script>
  </body>
</html>
