<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import TGF Players</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    body {
      background: #f5f5f5;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }

    .page-header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-header h1 {
      margin: 0;
      font-size: 24px;
      color: #1e293b;
    }

    .page-header .subtitle {
      color: #64748b;
      margin-top: 4px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #0b6efd;
      color: white;
    }

    .btn-primary:hover {
      background: #0a5ed7;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .panel h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #1e293b;
      font-size: 16px;
    }

    .instructions {
      background: #e0f2fe;
      border: 1px solid #7dd3fc;
      color: #0c4a6e;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .instructions ol {
      margin: 10px 0 0 0;
      padding-left: 20px;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .instructions a {
      color: #0369a1;
      font-weight: 600;
    }

    .paste-area {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 15px;
    }

    .paste-area:focus {
      border-color: #0b6efd;
      outline: none;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-bar input,
    .search-bar select {
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .search-bar input {
      flex: 1;
      min-width: 200px;
    }

    .search-bar select {
      min-width: 150px;
    }

    .stats-bar {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 14px;
    }

    .stats-bar .stat {
      display: flex;
      gap: 6px;
    }

    .stats-bar .stat-label {
      color: #64748b;
    }

    .stats-bar .stat-value {
      font-weight: 600;
      color: #1e293b;
    }

    .players-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .players-table thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
    }

    .players-table th {
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      white-space: nowrap;
    }

    .players-table th.center {
      text-align: center;
    }

    .players-table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .players-table td.center {
      text-align: center;
    }

    .players-table tr:hover {
      background: #f8f9fa;
    }

    .players-table tr.selected {
      background: #e3f2fd;
    }

    .players-table tr.already-exists {
      background: #fff3cd;
    }

    .players-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-male {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-female {
      background: #fce7f3;
      color: #be185d;
    }

    .badge-exists {
      background: #fef3c7;
      color: #92400e;
    }

    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <div>
        <h1>üáπüá∑ Import TGF Players</h1>
        <div class="subtitle">Import players from Turkish Golf Federation handicap list</div>
      </div>
      <div class="button-group">
        <button class="btn btn-secondary" onclick="goBack()">Back</button>
      </div>
    </div>

    <div class="panel" id="paste-panel">
      <h3>Step 1: Find and Copy Player Data</h3>
      
      <div class="search-assist" style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:15px;">
        <strong>üîç Quick Search:</strong>
        <p style="font-size:13px;color:#64748b;margin:8px 0;">Enter a player name to open TGF search in a new tab</p>
        <div style="display:flex;gap:10px;align-items:center;">
          <input type="text" id="search-name" placeholder="Enter player name (e.g., √ñzg√ºr)" 
                 style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
          <button class="btn btn-primary" onclick="openTGFSearch()">Search TGF</button>
        </div>
      </div>

      <div class="instructions">
        <strong>How to import:</strong>
        <ol>
          <li>Enter a name above and click "Search TGF" to open the search results</li>
          <li>On the TGF page, find the player(s) you want</li>
          <li>Select the table row(s) and copy (Ctrl+C or Cmd+C)</li>
          <li>Come back here and paste in the text area below</li>
          <li>Click "Parse Data" to extract player information</li>
        </ol>
        <p style="margin-top:10px;font-size:13px;color:#64748b;">
          Or open the <a href="https://scoring-tr.datagolf.pt/scripts/handicaps.asp?club=ALL&ack=6V35FTY88T&fedstatus=9" target="_blank">full TGF list</a> directly.
        </p>
      </div>
      <textarea id="paste-area" class="paste-area" placeholder="Paste the copied player data here..."></textarea>
      <div class="button-group">
        <button class="btn btn-primary" onclick="parseData()">üìã Parse Data</button>
        <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample (Test)</button>
      </div>
    </div>

    <div class="panel hidden" id="players-panel">
      <h3>Step 2: Select Players to Import</h3>
      
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search by name, club, or federation number..." oninput="filterPlayers()">
        <select id="gender-filter" onchange="filterPlayers()">
          <option value="">All Genders</option>
          <option value="M">Male</option>
          <option value="F">Female</option>
        </select>
        <select id="category-filter" onchange="filterPlayers()">
          <option value="">All Categories</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Clear Filters</button>
      </div>

      <div class="stats-bar">
        <div class="stat">
          <span class="stat-label">Total Parsed:</span>
          <span class="stat-value" id="total-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Filtered:</span>
          <span class="stat-value" id="filtered-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Selected:</span>
          <span class="stat-value" id="selected-count">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Already Exist:</span>
          <span class="stat-value" id="exists-count">0</span>
        </div>
      </div>

      <div class="table-container">
        <table class="players-table">
          <thead>
            <tr>
              <th class="center"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
              <th>Fed. No.</th>
              <th>Name</th>
              <th>Club</th>
              <th class="center">HCP</th>
              <th class="center">Gender</th>
              <th>Category</th>
              <th>Birth Date</th>
              <th class="center">Status</th>
            </tr>
          </thead>
          <tbody id="players-body"></tbody>
        </table>
      </div>

      <div class="action-bar">
        <div>
          <button class="btn btn-primary btn-sm" onclick="selectAllParsed()">Select ALL Fetched</button>
          <button class="btn btn-secondary btn-sm" onclick="selectAll()">Select Visible</button>
          <button class="btn btn-secondary btn-sm" onclick="deselectAll()">Deselect All</button>
          <button class="btn btn-warning btn-sm" onclick="selectNew()">Select Only New</button>
        </div>
        <button class="btn btn-success" onclick="importSelected()">‚úÖ Import Selected Players</button>
      </div>
    </div>
  </div>

  <script>
    var parsedPlayers = [];
    var filteredPlayers = [];
    var existingPlayers = [];
    var existingFedNumbers = {};

    function getPlayers() {
      try {
        var data = localStorage.getItem('players');
        console.log('getPlayers - raw length:', data ? data.length : 0);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        console.error('getPlayers error:', e);
        return [];
      }
    }

    function savePlayers(players) {
      try {
        var json = JSON.stringify(players);
        console.log('savePlayers - JSON length:', json.length, 'bytes, players:', players.length);
        localStorage.setItem('players', json);
        
        // Verify immediately
        var verify = localStorage.getItem('players');
        console.log('savePlayers - verified length:', verify ? verify.length : 0);
        
        if (!verify || verify.length < json.length * 0.9) {
          throw new Error('Data not saved properly');
        }
      } catch(e) {
        console.error('savePlayers error:', e);
        alert('ERROR saving players: ' + e.message + '\n\nThis may be a storage quota issue.');
        throw e;
      }
    }

    function openTGFSearch() {
      var searchName = document.getElementById('search-name').value.trim();
      if (!searchName) {
        alert('Please enter a player name to search.');
        return;
      }
      
      // The TGF site uses a form, so we'll open the page and user can type in the search
      // We'll include the name in the URL as a hint for the user
      var baseUrl = 'https://scoring-tr.datagolf.pt/scripts/handicaps.asp?club=ALL&ack=6V35FTY88T&fedstatus=9';
      
      // Open the TGF page in a new tab
      var newTab = window.open(baseUrl, '_blank');
      
      // Show instructions
      alert('TGF page opened in a new tab.\n\n' +
            '1. On that page, type "' + searchName + '" in the "ƒ∞sim:" (Name) field\n' +
            '2. Click "ARA" (Search) button\n' +
            '3. Select and copy the player row(s) you want\n' +
            '4. Come back here and paste');
    }

    function init() {
      console.log('Init - current origin:', window.location.origin);
      console.log('Init - current URL:', window.location.href);
      existingPlayers = getPlayers();
      console.log('Init - existing players:', existingPlayers.length);
      existingFedNumbers = {};
      existingPlayers.forEach(function(p) {
        // Check both federationNumber and reg (with or without P prefix)
        if (p.federationNumber) {
          existingFedNumbers[p.federationNumber] = true;
        }
        if (p.reg) {
          // If reg starts with P, also store the number without P
          if (p.reg.toString().startsWith('P')) {
            existingFedNumbers[p.reg.substring(1)] = true;
          }
          existingFedNumbers[p.reg] = true;
        }
      });
    }

    function parseData() {
      var text = document.getElementById('paste-area').value.trim();
      if (!text) {
        alert('Please paste the table data first.');
        return;
      }

      parsedPlayers = [];
      var lines = text.split('\n');
      var categories = {};

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;

        // Try to parse as table row
        // Expected format: Fed.No. | Name | Club | HCP | HCP Type | Gender | Category | Fed Status | License | Birth Date
        var parts = line.split('\t');
        if (parts.length < 5) {
          parts = line.split('|').map(function(p) { return p.trim(); });
        }
        if (parts.length < 5) continue;

        // Skip header rows
        if (parts[0] === 'Feder.No.' || parts[0] === '---' || parts[1] === 'ƒ∞sim') continue;

        var fedNo = parts[0] ? parts[0].trim() : '';
        var fullName = parts[1] ? parts[1].trim() : '';
        var club = parts[2] ? parts[2].trim() : '';
        var hcp = parts[3] ? parts[3].trim() : '';
        var gender = parts[5] ? parts[5].trim() : '';
        var category = parts[6] ? parts[6].trim() : '';
        var birthDate = parts[9] ? parts[9].trim() : '';

        // Validate: must have at least fed number and name
        if (!fedNo || !fullName || isNaN(parseInt(fedNo))) continue;

        // Parse name into first/last
        var nameParts = fullName.split(' ');
        var firstName = nameParts[0] || '';
        var lastName = nameParts.slice(1).join(' ') || '';

        // Parse club - remove code prefix if present (e.g., "113-Bodrum GK" -> "Bodrum GK")
        var clubName = club;
        var clubMatch = club.match(/^\d+-(.+)$/);
        if (clubMatch) {
          clubName = clubMatch[1];
        }

        // Parse handicap
        var handicap = parseFloat(hcp) || null;

        // Track categories
        if (category) {
          categories[category] = true;
        }

        parsedPlayers.push({
          federationNumber: fedNo,
          firstName: firstName,
          lastName: lastName,
          fullName: fullName,
          club: clubName,
          clubRaw: club,
          handicap: handicap,
          gender: gender,
          category: category,
          birthDate: birthDate,
          country: 'TUR',
          exists: existingFedNumbers[fedNo] || false,
          selected: false
        });
      }

      if (parsedPlayers.length === 0) {
        alert('Could not parse any player data. Make sure you copied the table correctly.');
        return;
      }

      // Populate category filter
      var categorySelect = document.getElementById('category-filter');
      categorySelect.innerHTML = '<option value="">All Categories</option>';
      Object.keys(categories).sort().forEach(function(cat) {
        var option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });

      filteredPlayers = parsedPlayers.slice();
      renderPlayers();
      updateStats();

      document.getElementById('paste-panel').classList.add('hidden');
      document.getElementById('players-panel').classList.remove('hidden');
    }

    function renderPlayers() {
      var tbody = document.getElementById('players-body');
      var html = '';

      filteredPlayers.forEach(function(player, idx) {
        var rowClass = '';
        if (player.selected) rowClass += ' selected';
        if (player.exists) rowClass += ' already-exists';

        html += '<tr class="' + rowClass.trim() + '" data-idx="' + idx + '">';
        html += '<td class="center"><input type="checkbox" ' + (player.selected ? 'checked' : '') + ' onchange="togglePlayer(' + idx + ')"></td>';
        html += '<td>' + player.federationNumber + '</td>';
        html += '<td><strong>' + player.firstName + '</strong> ' + player.lastName + '</td>';
        html += '<td>' + player.club + '</td>';
        html += '<td class="center">' + (player.handicap !== null ? player.handicap.toFixed(1) : '-') + '</td>';
        html += '<td class="center"><span class="badge ' + (player.gender === 'F' ? 'badge-female' : 'badge-male') + '">' + player.gender + '</span></td>';
        html += '<td>' + (player.category || '-') + '</td>';
        html += '<td>' + (player.birthDate || '-') + '</td>';
        html += '<td class="center">' + (player.exists ? '<span class="badge badge-exists">Exists</span>' : '') + '</td>';
        html += '</tr>';
      });

      tbody.innerHTML = html || '<tr><td colspan="9" class="no-data">No players found</td></tr>';
    }

    function filterPlayers() {
      var search = document.getElementById('search-input').value.toLowerCase();
      var gender = document.getElementById('gender-filter').value;
      var category = document.getElementById('category-filter').value;

      filteredPlayers = parsedPlayers.filter(function(p) {
        if (gender && p.gender !== gender) return false;
        if (category && p.category !== category) return false;
        if (search) {
          var searchStr = (p.fullName + ' ' + p.club + ' ' + p.federationNumber).toLowerCase();
          if (searchStr.indexOf(search) === -1) return false;
        }
        return true;
      });

      renderPlayers();
      updateStats();
    }

    function clearFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('gender-filter').value = '';
      document.getElementById('category-filter').value = '';
      filterPlayers();
    }

    function togglePlayer(idx) {
      filteredPlayers[idx].selected = !filteredPlayers[idx].selected;
      renderPlayers();
      updateStats();
    }

    function toggleSelectAll() {
      var checked = document.getElementById('select-all').checked;
      filteredPlayers.forEach(function(p) {
        p.selected = checked;
      });
      renderPlayers();
      updateStats();
    }

    function selectAllParsed() {
      parsedPlayers.forEach(function(p) {
        p.selected = true;
      });
      renderPlayers();
      updateStats();
    }

    function selectAll() {
      filteredPlayers.forEach(function(p) {
        p.selected = true;
      });
      renderPlayers();
      updateStats();
    }

    function deselectAll() {
      parsedPlayers.forEach(function(p) {
        p.selected = false;
      });
      renderPlayers();
      updateStats();
    }

    function selectNew() {
      parsedPlayers.forEach(function(p) {
        p.selected = !p.exists;
      });
      filterPlayers();
    }

    function updateStats() {
      var selected = 0;
      var exists = 0;
      parsedPlayers.forEach(function(p) {
        if (p.selected) selected++;
        if (p.exists) exists++;
      });

      document.getElementById('total-count').textContent = parsedPlayers.length;
      document.getElementById('filtered-count').textContent = filteredPlayers.length;
      document.getElementById('selected-count').textContent = selected;
      document.getElementById('exists-count').textContent = exists;
    }

    function importSelected() {
      var toImport = parsedPlayers.filter(function(p) { return p.selected; });
      
      console.log('Total parsed players:', parsedPlayers.length);
      console.log('Selected players to import:', toImport.length);
      
      if (toImport.length === 0) {
        alert('Please select at least one player to import.\n\nUse "Select All Visible" or "Select Only New" buttons first, or check individual players.');
        return;
      }

      var confirmMsg = 'Import ' + toImport.length + ' player(s)?';
      if (!confirm(confirmMsg)) return;

      var newCount = 0;
      var updateCount = 0;
      var players = getPlayers();
      
      console.log('Existing players before import:', players.length);

      toImport.forEach(function(p) {
        // Check if player already exists by federation number or reg
        var existingIdx = -1;
        for (var i = 0; i < players.length; i++) {
          var regWithP = 'P' + p.federationNumber;
          if (players[i].federationNumber === p.federationNumber || 
              players[i].reg === p.federationNumber ||
              players[i].reg === regWithP) {
            existingIdx = i;
            break;
          }
        }

        // TGF date format is already YYYY-MM-DD which is what HTML date input expects
        // Keep it as-is for dob field
        var dob = p.birthDate || '';

        // Use field names that match the Players page expectations
        // Add 'P' prefix to reg number to match your system
        var regNo = 'P' + p.federationNumber;
        
        // Convert gender: TGF uses M/F, system might expect male/female
        var genderValue = p.gender;
        if (p.gender === 'M') genderValue = 'male';
        else if (p.gender === 'F') genderValue = 'female';
        
        var playerData = {
          id: regNo,
          reg: regNo,  // Players page uses 'reg' for display - with P prefix
          federationNumber: p.federationNumber,  // Keep original TGF number
          firstName: p.firstName,
          lastName: p.lastName,
          club: p.club,
          homeClub: p.club,
          hcp: p.handicap,  // Players page uses 'hcp'
          handicap: p.handicap,
          gender: genderValue,
          category: p.category,
          dob: dob,  // YYYY-MM-DD format for HTML date input
          country: 'TUR',
          owner: 'main'  // Set owner so it shows for admin
        };

        if (existingIdx >= 0) {
          // Update existing player
          players[existingIdx] = Object.assign(players[existingIdx], playerData);
          updateCount++;
        } else {
          // Add new player
          players.push(playerData);
          newCount++;
        }
      });

      console.log('Players after import:', players.length);
      
      try {
        savePlayers(players);
        console.log('Save successful');
        
        // Verify save
        var verify = getPlayers();
        console.log('Verified player count:', verify.length);
      } catch(e) {
        console.error('Save error:', e);
        alert('Error saving players: ' + e.message);
        return;
      }

      var msg = 'Import complete!\n';
      if (newCount > 0) msg += '- ' + newCount + ' new player(s) added\n';
      if (updateCount > 0) msg += '- ' + updateCount + ' existing player(s) updated';
      msg += '\n\nTotal players now: ' + players.length;
      
      alert(msg);

      // Refresh existing players list
      init();
      
      // Update exists status
      parsedPlayers.forEach(function(p) {
        p.exists = existingFedNumbers[p.federationNumber] || false;
        p.selected = false;
      });
      
      filterPlayers();
    }

    function loadSampleData() {
      var sampleData = [
        '264\tAbd√ºlkadir Esen\t113-Bodrum GK\t15.4\tAktif\tM\tSenior\tAktif\t2512\t1959-08-07',
        '6013\tAbdullah Alper √ñz\t178-19 Mayƒ±s Samsun\t33.6\tAktif\tM\tM-A\tAktif\t2512\t1982-01-01',
        '4921\tAbdullah Diltemiz\t175-Ata≈üehir Golf\t45.1\tAktif\tM\tSenior\tAktif\t2412\t1975-01-01',
        '3115\tAda Akarbulut\t165-Albatros GC\t31.8\tAktif\tF\tYƒ±ldƒ±z(U16)\tAktif\t1712\t2009-03-15',
        '6822\tAda √áelen\t175-Ata≈üehir Golf\t49.5\tAktif\tF\tMinik(U11)\tAktif\t2512\t2017-02-20',
        '5113\tAda Ercivan\t126-AGGSK\t22.6\tAktif\tF\tYƒ±ldƒ±z(U16)\tAktif\t2412\t2009-10-06'
      ].join('\n');
      
      document.getElementById('paste-area').value = sampleData;
    }

    function goBack() {
      window.location.href = 'index.html';
    }

    init();
  </script>
</body>
</html>
