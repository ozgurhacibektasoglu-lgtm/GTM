<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Players Administration</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <link rel="stylesheet" href="../styles.css">
    <style>
      body { margin: 0; padding: 0; }
      
      /* Top Navigation Bar */
      .top-nav {
        background: linear-gradient(135deg, #0b6efd 0%, #0a58d1 100%);
        padding: 16px 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .top-nav h1 {
        margin: 0;
        color: white;
        font-size: 24px;
        font-weight: 700;
      }
      
      .btn-back-top {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-block;
      }
      
      .btn-back-top:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-1px);
      }
      
      /* Action Buttons - Below Header */
      .action-buttons-container {
        background: #f8fafc;
        padding: 16px 24px;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .btn { background: linear-gradient(180deg, var(--accent), #0a58d1); color: white; border: 0; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: transform 0.08s; flex: 0 0 calc((100% - 70px) / 8); }
      .btn:active { transform: translateY(1px); }
      
      .players-container { max-width: 1200px; margin: 24px auto; padding: 24px; }
      .search-box { margin-bottom: 16px; }
      .search-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e6e9ef; font-size: 15px; }
      .table-wrapper { background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.06); overflow-x: auto; }
      table.players { width: 100%; border-collapse: collapse; }
      table.players th { background: #f3f4f6; font-weight: 600; text-align: left; padding: 12px 16px; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; }
      table.players th.sortable { cursor: pointer; user-select: none; }
      table.players td { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
      table.players tr { cursor: pointer; }
      table.players tr.selected { background: #dbeafe; }
      table.players tbody tr:hover { background: #f0f9ff; }
      .sort-indicator { margin-left: 8px; font-size: 12px; color: #475569; }
      #players-status { font-size: 13px; color: #475569; margin-bottom: 12px; }
    </style>
  </head>
  <body>
    <!-- Top Navigation -->
    <div class="top-nav">
      <h1>üèåÔ∏è Players</h1>
      <a href="../index.html" class="btn-back-top">‚Üê Back</a>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons-container">
      <div class="action-buttons">
        <div class="button-row">
          <button class="btn" id="btn-create-player">Create Player</button>
          <button class="btn" id="btn-modify-player">Modify Player</button>
          <button class="btn" id="btn-search-player">Search Player</button>
          <button class="btn" id="btn-import-tgf">üáπüá∑ Import from TGF</button>
          <button class="btn" id="btn-payments">Payments</button>
          <button class="btn" id="btn-export-players" style="background: linear-gradient(180deg, #059669, #047857);">üì§ Export</button>
          <button class="btn" id="btn-import-players" style="background: linear-gradient(180deg, #8b5cf6, #7c3aed);">üì• Import</button>
          <button class="btn" id="btn-delete-player" style="background: linear-gradient(180deg, #dc2626, #991b1b);">üóëÔ∏è Delete Player</button>
          <input id="import-file" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>
    
    <main class="players-container">
      <div class="search-box">
        <input id="player-search" placeholder="Search by reg no, name, or home club" />
      </div>
      <div id="players-status"></div>
      
      <div class="table-wrapper">
        <table class="players" id="players-table">
          <thead>
            <tr>
              <th class="sortable" data-key="reg">Reg. No <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="firstName">First Name <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="lastName">Last Name <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="hcp">HCP <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="ageGroup">Age Group <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="age">Age <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="gender">Gender <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="homeClub">Home Club <span class="sort-indicator"></span></th>
              <th class="sortable" data-key="mobile">Mobile <span class="sort-indicator"></span></th>
            </tr>
          </thead>
          <tbody id="players-body"></tbody>
        </table>
      </div>
      
      <div id="search-results" style="margin-top:18px"></div>
    </main>

    <script>
      // Players admin: stored in localStorage under 'players'
      
      // Auto-recovery: If players array is empty but backup exists, restore it
      (function autoRecover() {
        try {
          const current = localStorage.getItem('players');
          const backup = localStorage.getItem('players_backup');
          
          if ((!current || current === '[]' || current === 'null') && backup && backup !== '[]') {
            console.log('‚ö†Ô∏è Players data missing, restoring from backup...');
            localStorage.setItem('players', backup);
            console.log('‚úì Players restored from backup');
          }
        } catch(e) {
          console.error('Auto-recovery failed:', e);
        }
      })();
      
      // Local functions for players
      function getPlayers() {
        try { 
          const raw = localStorage.getItem('players'); 
          return raw ? JSON.parse(raw) : [];
        } catch(e) {
          console.error(e);
          return [];
        }
      }
      
      // Flag to prevent sync loops
      let isSyncing = false;
      let lastSyncTime = 0;
      
      function savePlayers(list) {
        try{
          // keep a backup of previous state to help recovery
          const prev = localStorage.getItem('players');
          if(prev) localStorage.setItem('players_backup', prev);
          localStorage.setItem('players', JSON.stringify(list || []));
          localStorage.setItem('players_backup_ts', new Date().toISOString());
          
          // Mark that we're syncing to prevent incoming updates from overwriting
          isSyncing = true;
          lastSyncTime = Date.now();
          
          // Sync to Firebase automatically
          if (typeof syncToFirebase !== 'undefined') {
            syncToFirebase('players', list || []).then(function() {
              console.log('‚úì Players synced to cloud:', (list || []).length);
              setTimeout(function() { isSyncing = false; }, 2000); // Allow incoming updates after 2 sec
            }).catch(function() {
              isSyncing = false;
            });
          } else {
            isSyncing = false;
          }
        } catch(e) { 
          console.error('savePlayers error', e);
          isSyncing = false;
        }
      }
      
      // Real-time listener for Firebase updates
      function setupRealtimeSync() {
        if (typeof firebase === 'undefined' || !firebase.database) {
          console.log('Firebase not available for realtime sync');
          return;
        }
        
        try {
          // Use explicit database URL to avoid region warnings
          firebase.app().database(window.firebaseConfig.databaseURL).ref('players').on('value', function(snapshot) {
            // Don't process if we just saved locally (prevents overwriting our own changes)
            if (isSyncing) {
              console.log('‚è∏ Ignoring Firebase update (local save in progress)');
              return;
            }
            
            const data = snapshot.val();
            if (data) {
              const currentLocal = getPlayers();
              
              // Convert Firebase object format to array (or handle legacy array)
              let playersArray = [];
              if (Array.isArray(data)) {
                playersArray = data; // Legacy format
              } else if (typeof data === 'object') {
                playersArray = Object.values(data); // New object format keyed by reg no
              }
              
              // Only update if Firebase has MORE data than local
              // This prevents older Firebase data from overwriting newer local data
              if (playersArray.length > currentLocal.length) {
                console.log('üì• Received update from cloud:', playersArray.length, 'players (local had', currentLocal.length, ')');
                localStorage.setItem('players', JSON.stringify(playersArray));
                loadPlayers(); // Refresh the display
              } else {
                console.log('üì• Firebase has', playersArray.length, 'players, local has', currentLocal.length, '- keeping local');
              }
            }
          });
          console.log('‚úì Real-time sync enabled');
        } catch(e) {
          console.error('Realtime sync setup failed:', e);
        }
      }

      // sample data disabled - use import instead
      function ensureSample() {
        // No longer auto-creating sample data
      }

      let sortState = { key: 'reg', dir: 'asc' };

      function getCurrentUser(){
        try{ const raw = localStorage.getItem('currentUser'); if(raw) return JSON.parse(raw); }catch(e){}
        return { id: 'main', name: 'Main Admin', role: 'admin' };
      }

      function setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); }

      function renderUserSelector(){
        const sel = document.getElementById('user-selector');
        if (!sel) return; // Element removed in new layout
        const cur = getCurrentUser();
        sel.value = cur.id;
        sel.addEventListener('change', ()=>{
          const v = sel.value;
          const u = v==='main'? {id:'main',name:'Main Admin',role:'admin'} : {id:v,name: sel.options[sel.selectedIndex].text, role:'club'};
          setCurrentUser(u); loadPlayers(); document.getElementById('search-results').innerHTML='';
        });
      }

      // Calculate age based on January 1st of current year
      function calculateAge(dob) {
        if (!dob) return '';
        try {
          const birthDate = new Date(dob);
          const currentYear = new Date().getFullYear();
          const referenceDate = new Date(currentYear, 0, 1); // January 1st of current year
          let age = referenceDate.getFullYear() - birthDate.getFullYear();
          return age;
        } catch (e) {
          return '';
        }
      }

      // Get age group based on age
      function getAgeGroup(age) {
        if (!age && age !== 0) return '';
        
        try {
          const prefsRaw = localStorage.getItem('preferences');
          if (!prefsRaw) return '';
          
          const prefs = JSON.parse(prefsRaw);
          const ageGroups = prefs.ageGroups || [];
          
          for (let group of ageGroups) {
            if (age >= group.minAge && age <= group.maxAge) {
              return group.name;
            }
          }
        } catch(e) {
          console.error('Error getting age group:', e);
        }
        
        return '';
      }

      // Update age and age group for all players
      function updateAllPlayersAgeGroups() {
        try {
          const players = getPlayers();
          let updated = false;
          
          players.forEach(player => {
            if (player.dob) {
              const age = calculateAge(player.dob);
              const ageGroup = getAgeGroup(age);
              
              if (player.age !== age || player.ageGroup !== ageGroup) {
                player.age = age;
                player.ageGroup = ageGroup;
                updated = true;
              }
            }
          });
          
          if (updated) {
            savePlayers(players);
            console.log('‚úì Updated age groups for all players');
          }
        } catch(e) {
          console.error('Error updating age groups:', e);
        }
      }

      // Format handicap for display (negative values show as +)
      function formatHcp(hcp) {
        if (!hcp && hcp !== 0) return '';
        const num = parseFloat(hcp);
        if (isNaN(num)) return hcp;
        if (num < 0) return '+' + Math.abs(num).toFixed(1);
        return num.toFixed(1);
      }

      function loadPlayers() {
        const tbody = document.getElementById('players-body');
        const filter = (document.getElementById('player-search').value || '').toLowerCase();
        const list = getPlayers() || [];

        // Safety check - ensure list is an array
        if (!Array.isArray(list)) {
          console.error('Players data is not an array:', list);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#dc3545;">Error loading players. Try refreshing the page.</td></tr>';
          return;
        }

        // augment with orig index and calculated age/age group
        const augmented = list.map((p, i) => {
          const age = calculateAge(p.dob);
          const ageGroup = getAgeGroup(age);
          return Object.assign({_origIndex:i, age: age, ageGroup: ageGroup}, p);
        });

        const currentUser = getCurrentUser();

        // filter by ownership: admin sees all, clubs see own or imported
        const visible = augmented.filter(p => {
          if(currentUser.role==='admin') return true;
          if(p.owner === currentUser.id) return true;
          if(Array.isArray(p.importedBy) && p.importedBy.includes(currentUser.id)) return true;
          return false;
        });

        // then apply search filter
        const filtered = visible.filter(p => {
          if (!filter) return true;
          return (p.reg||'').toString().toLowerCase().includes(filter) || ((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase().includes(filter) || (p.club||'').toLowerCase().includes(filter);
        });

        // sort
        filtered.sort((a,b)=>{
          const k = sortState.key; let va=a[k], vb=b[k];
          if(k==='hcp' || k==='age') { va = parseFloat(va)||0; vb = parseFloat(vb)||0; return sortState.dir==='asc'? va - vb: vb - va }
          va = (va||'').toString().toLowerCase(); vb = (vb||'').toString().toLowerCase();
          if(va<vb) return sortState.dir==='asc'? -1: 1; if(va>vb) return sortState.dir==='asc'? 1: -1; return 0;
        });

        tbody.innerHTML = '';
        filtered.forEach((p, idx)=>{
          const tr = document.createElement('tr');
          const mobileCell = p.mobile ? escapeHtml(p.mobile) : '';
          const homeClubCell = p.homeClub ? escapeHtml(p.homeClub) : (p.club ? escapeHtml(p.club) : '');
          const ageGroupCell = p.ageGroup ? escapeHtml(p.ageGroup) : '';
          tr.innerHTML = `<td>${escapeHtml(p.reg)}</td><td>${escapeHtml(p.firstName||'')}</td><td>${escapeHtml(p.lastName||'')}</td><td>${formatHcp(p.hcp)}</td><td>${ageGroupCell}</td><td>${escapeHtml(p.age||'')}</td><td>${escapeHtml(p.gender||'')}</td><td>${homeClubCell}</td><td>${mobileCell}</td>`;
          tr.dataset.index = idx; tr.dataset.origIndex = p._origIndex;
          tr.addEventListener('click', ()=>{ selectPlayer(p._origIndex, p); });
          tbody.appendChild(tr);
        });
        // status / debug info
        const status = document.getElementById('players-status');
        if(status){
          status.textContent = `Showing ${filtered.length} players (visible: ${visible.length}) ‚Äî total stored: ${list.length}`;
        }
        // also log stored players for debugging
        console.log('players (stored):', list);
      }

      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&\"'<>]/g, c=>({'&':'&amp;','\"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'}[c])) }

      function setupSorting(){
        document.querySelectorAll('#players-table thead th').forEach(th=>{
          const key = th.dataset.key; if(!key) return; th.classList.add('sortable');
          th.addEventListener('click', ()=>{
            if(sortState.key===key) sortState.dir = sortState.dir==='asc'?'desc':'asc'; else { sortState.key=key; sortState.dir='asc' }
            loadPlayers(); renderSortIndicators();
          })
        })
      }

      function renderSortIndicators(){
        document.querySelectorAll('#players-table thead th').forEach(th=>{
          const key = th.dataset.key; const ind = th.querySelector('.sort-indicator');
          if(!ind) return; ind.textContent = key===sortState.key ? (sortState.dir==='asc'? '‚ñ≤':'‚ñº') : '';
        })
      }

      let selectedPlayerIndex = null;
      function selectPlayer(origIndex, player){
        selectedPlayerIndex = origIndex;
        // highlight selected row only
        document.querySelectorAll('#players-body tr').forEach(r=>r.classList.remove('selected'));
        const rows = Array.from(document.querySelectorAll('#players-body tr'));
        const row = rows.find(r=>parseInt(r.dataset.origIndex,10)===origIndex);
        if(row) row.classList.add('selected');
      }

      // Create Player (open the dedicated create page)
      document.getElementById('btn-create-player').addEventListener('click', ()=>{
        // use relative path from /players/index.html
        window.location.href = 'new.html';
      });

      // Export players to JSON file
      document.getElementById('btn-export-players').addEventListener('click', ()=>{
        const data = getPlayers();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'players_export_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // Import players from JSON file (replace storage)
      const importFile = document.getElementById('import-file');
      document.getElementById('btn-import-players').addEventListener('click', ()=>{ importFile.click(); });
      importFile.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = (ev)=>{
          try{
            const parsed = JSON.parse(ev.target.result);
            if(!Array.isArray(parsed)) return alert('Import file must be an array of players');
            if(!confirm('This will replace the current players list. Continue?')) return;
            savePlayers(parsed);
            loadPlayers();
            alert('Import complete.');
          }catch(err){ alert('Invalid JSON file: ' + err.message) }
        };
        reader.readAsText(f);
      });

      // Modify selected player
      document.getElementById('btn-modify-player').addEventListener('click', ()=>{
        if(selectedPlayerIndex === null){ alert('Please select a player to modify.'); return }
        const players = getPlayers();
        if (!players[selectedPlayerIndex]) {
          alert('Player not found. Please select a player from the table.');
          return;
        }
        console.log('Modifying player at index:', selectedPlayerIndex, players[selectedPlayerIndex]);
        // navigate to new.html in edit mode
        window.location.href = 'new.html?edit=' + selectedPlayerIndex;
      });

      // Delete selected player (admin only)
      document.getElementById('btn-delete-player').addEventListener('click', ()=>{
        const currentUser = getCurrentUser();
        if(currentUser.role !== 'admin'){
          alert('Only administrators can delete players.');
          return;
        }
        if(selectedPlayerIndex === null){ alert('Please select a player to delete.'); return }
        const list = getPlayers();
        const player = list[selectedPlayerIndex];
        if(!player){ alert('Player not found.'); return }
        const playerName = (player.firstName || '') + ' ' + (player.lastName || '');
        if(!confirm('Are you sure you want to delete player "' + playerName.trim() + '" (Reg: ' + (player.reg || 'N/A') + ')?\n\nThis action cannot be undone.')){
          return;
        }
        list.splice(selectedPlayerIndex, 1);
        savePlayers(list);
        selectedPlayerIndex = null;
        loadPlayers();
        alert('Player deleted successfully.');
      });

      // Search Player (search across saved players)
      document.getElementById('btn-search-player').addEventListener('click', ()=>{
        const q = window.prompt('Search players (reg, name, club):');
        if(q===null) return;
        const term = (q||'').toLowerCase();
        const all = getPlayers();
        const matches = all.map((p,i)=>Object.assign({_origIndex:i},p)).filter(p => (p.reg||'').toLowerCase().includes(term) || (((p.firstName||'') + ' ' + (p.lastName||'')).toLowerCase().includes(term)) || (p.club||'').toLowerCase().includes(term));
        const out = document.getElementById('search-results');
        const currentUser = getCurrentUser();
        if(matches.length===0){ out.innerHTML = `<p>No matches for "${escapeHtml(q)}"</p>`; return }
        out.innerHTML = '<strong>Matches:</strong><ul>' + matches.map(m=>{
          const visible = (currentUser.role==='admin') || (m.owner===currentUser.id) || (Array.isArray(m.importedBy) && m.importedBy.includes(currentUser.id));
          const addBtn = (!visible && currentUser.role!=='admin') ? `<button data-orig="${m._origIndex}" class="btn-add" style="margin-left:8px">Add to my list</button>` : '';
          return `<li>${escapeHtml(m.reg)} ‚Äî ${escapeHtml((m.firstName||'') + ' ' + (m.lastName||''))} (${escapeHtml(m.club)}) ${addBtn}</li>`
        }).join('') + '</ul>';

        // wire add buttons
        Array.from(out.querySelectorAll('.btn-add')).forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const idx = parseInt(e.target.dataset.orig,10);
            addToMyList(idx);
          })
        });
      });

      function addToMyList(origIndex){
        const currentUser = getCurrentUser();
        const list = getPlayers();
        const p = list[origIndex];
        if(!p) return alert('Player not found');
        p.importedBy = p.importedBy || [];
        if(!p.importedBy.includes(currentUser.id)) p.importedBy.push(currentUser.id);
        savePlayers(list);
        loadPlayers();
        document.getElementById('search-results').innerHTML = `<p>Added ${escapeHtml((p.firstName||'') + ' ' + (p.lastName||''))} to your list.</p>`;
      }

      document.getElementById('btn-payments').addEventListener('click', ()=>{
        alert('Payments functionality coming soon.');
      });

      document.getElementById('btn-import-tgf').addEventListener('click', ()=>{
        window.location.href = 'import_tgf.html';
      });

      // Init
      ensureSample();
      // initialize user selector and persist current user if not set
      renderUserSelector();
      setCurrentUser(getCurrentUser());
      setupSorting();
      
      // Update age groups for all players (recalculate based on preferences)
      updateAllPlayersAgeGroups();
      
      // Load players from localStorage first
      loadPlayers();
      renderSortIndicators();
      
      // Start real-time sync with Firebase after a short delay
      setTimeout(function() {
        setupRealtimeSync();
      }, 1500);

      // Replace history so back button goes to main page instead of previous search page
      history.replaceState(null, '', location.href);
      window.addEventListener('popstate', function() {
        window.location.href = '../index.html';
      });

      // Search
      document.getElementById('player-search').addEventListener('input', ()=>{ loadPlayers() });
    </script>
  </body>
</html>
