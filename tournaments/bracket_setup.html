<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bracket Match Play Setup</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="../firebase-config.js"></script>
  
  <link rel="stylesheet" href="../styles.css">
  <style>
    body { padding-top: 70px; background: #f8fafc; }
    
    .container { max-width: 1400px; margin: 20px auto; padding: 20px; }
    
    .tournament-header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tournament-header h2 { margin: 0 0 12px 0; color: #1e293b; }
    .tournament-info { display: flex; gap: 24px; font-size: 14px; color: #64748b; flex-wrap: wrap; }
    .tournament-info-item { display: flex; align-items: center; gap: 8px; }
    .tournament-info-item strong { color: #1e293b; }
    
    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
    }
    
    /* Player List Panel */
    .players-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .players-panel h3 { margin: 0 0 16px 0; color: #1e293b; font-size: 18px; }
    
    .player-search {
      margin-bottom: 16px;
    }
    
    .player-search input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .player-item {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    
    .player-item:hover {
      border-color: #0b6efd;
      background: #f0f9ff;
    }
    
    .player-item.selected {
      border-color: #0b6efd;
      background: #dbeafe;
    }
    
    .player-name { font-weight: 600; color: #1e293b; margin-bottom: 4px; }
    .player-details { font-size: 12px; color: #64748b; }
    
    /* Bracket Setup Panel */
    .bracket-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .bracket-panel h3 { margin: 0 0 20px 0; color: #1e293b; font-size: 18px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #0b6efd;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .setup-section {
      margin-bottom: 32px;
    }
    
    .setup-section h4 {
      margin: 0 0 16px 0;
      color: #1e293b;
      font-size: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .field-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .field label {
      font-weight: 600;
      font-size: 13px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .field select, .field input {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .field .help-text {
      font-size: 12px;
      color: #64748b;
      margin-top: -4px;
    }
    
    .seeding-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }
    
    .seeding-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
    }
    
    .seed-number {
      font-weight: 700;
      color: #0b6efd;
      min-width: 30px;
    }
    
    .seeding-item .player-name {
      flex: 1;
      margin: 0;
    }
    
    .seeding-item .player-details {
      margin: 0;
    }
    
    .btn-move {
      padding: 4px 8px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn-move:hover {
      background: #e2e8f0;
    }
    
    .btn-remove {
      padding: 4px 8px;
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn-remove:hover {
      background: #fecaca;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid #e2e8f0;
    }
    
    .btn {
      padding: 12px 24px;
      border: 0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(180deg, #0b6efd, #0a58d1);
      color: white;
      flex: 1;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(11,110,253,0.3);
    }
    
    .btn-secondary {
      background: white;
      border: 1px solid #e2e8f0;
      color: #475569;
    }
    
    .btn-secondary:hover {
      background: #f8fafc;
    }
    
    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .info-box h4 {
      margin: 0 0 8px 0;
      color: #1e40af;
      font-size: 14px;
    }
    
    .info-box p {
      margin: 0;
      color: #1e40af;
      font-size: 13px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="top-nav">
    <h1>üèÜ Bracket Match Play Setup</h1>
    <a href="index.html" class="btn-back-top">‚Üê Back to Tournaments</a>
  </div>

  <div class="container">
    <!-- Tournament Header -->
    <div class="tournament-header">
      <h2 id="tournament-name">Loading...</h2>
      <div class="tournament-info">
        <div class="tournament-info-item">
          <strong>Date:</strong>
          <span id="tournament-date">-</span>
        </div>
        <div class="tournament-info-item">
          <strong>Format:</strong>
          <span id="tournament-format">-</span>
        </div>
        <div class="tournament-info-item">
          <strong>Course:</strong>
          <span id="tournament-course">-</span>
        </div>
        <div class="tournament-info-item">
          <strong>Target Bracket Size:</strong>
          <span id="bracket-size">-</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <!-- Left Panel: Player List -->
      <div class="players-panel">
        <h3>Available Players</h3>
        <div class="player-search">
          <input type="text" id="player-search" placeholder="üîç Search players...">
        </div>
        <div class="player-list" id="player-list">
          <!-- Players will be populated here -->
        </div>
      </div>

      <!-- Right Panel: Bracket Setup -->
      <div class="bracket-panel">
        <h3>Bracket Configuration</h3>
        
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-selected">0</div>
            <div class="stat-label">Selected Players</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-bracket-slots">64</div>
            <div class="stat-label">Bracket Slots</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-qualifying">0</div>
            <div class="stat-label">Qualifying Matches</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-byes">0</div>
            <div class="stat-label">Byes</div>
          </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
          <h4>üìã How Bracket Setup Works</h4>
          <p>
            Select players from the left panel to add them to the bracket. You can seed players manually or use automatic seeding based on handicap.
            If you have more players than bracket slots, qualifying matches will be automatically created. Players with byes will advance directly to the next round.
          </p>
        </div>

        <!-- Seeding Method -->
        <div class="setup-section">
          <h4>Seeding Configuration</h4>
          <div class="field-group">
            <div class="field">
              <label>Seeding Method</label>
              <select id="seeding-method">
                <option value="manual">Manual Seeding</option>
                <option value="handicap" selected>By Handicap (Lowest HCP = Seed 1)</option>
                <option value="random">Random Seeding</option>
              </select>
              <span class="help-text">How players will be ordered in the bracket</span>
            </div>
            <div class="field">
              <label>Bracket Size</label>
              <select id="bracket-size-select">
                <option value="4">4 Players</option>
                <option value="8">8 Players</option>
                <option value="16">16 Players</option>
                <option value="32">32 Players</option>
                <option value="64" selected>64 Players</option>
                <option value="128">128 Players</option>
              </select>
              <span class="help-text">Target bracket size (power of 2)</span>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="applySeedingMethod()">Apply Seeding</button>
        </div>

        <!-- Player Seeding List -->
        <div class="setup-section">
          <h4>Player Seeds <span style="font-weight:400; font-size:13px; color:#64748b;">(Drag to reorder or use move buttons)</span></h4>
          <div class="seeding-list" id="seeding-list">
            <p style="text-align:center; color:#94a3b8; padding:40px 0;">No players selected yet. Click players from the left panel to add them.</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
          <button class="btn btn-primary" onclick="generateBracket()">Generate Bracket</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTournament = null;
    let allPlayers = [];
    let selectedPlayers = [];
    let admittedPlayersList = [];

    // Load data
    function getTournaments() {
      return JSON.parse(localStorage.getItem('tournaments') || '[]');
    }

    function saveTournaments(list) {
      localStorage.setItem('tournaments', JSON.stringify(list));
    }

    function getPlayers() {
      return JSON.parse(localStorage.getItem('players') || '[]');
    }

    function getAdmittedPlayers() {
      return JSON.parse(localStorage.getItem('admittedPlayers') || '{}');
    }

    function getCourses() {
      return JSON.parse(localStorage.getItem('courses') || '[]');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Initialize
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const tournamentId = params.get('tournamentId');
      
      if (!tournamentId) {
        alert('No tournament specified');
        window.location.href = 'index.html';
        return;
      }

      // Load from Firebase first
      try {
        if (typeof loadPlayersFromFirebase !== 'undefined') {
          await loadPlayersFromFirebase();
        }
        if (typeof loadTournamentsFromFirebase !== 'undefined') {
          await loadTournamentsFromFirebase();
        }
      } catch(e) {
        console.log('Firebase load error:', e);
      }

      const tournaments = getTournaments();
      currentTournament = tournaments.find(t => t.tournamentId === tournamentId);
      
      if (!currentTournament) {
        alert('Tournament not found');
        window.location.href = 'index.html';
        return;
      }

      if (currentTournament.type !== 'match' || currentTournament.matchType !== 'bracket') {
        alert('This is not a bracket tournament');
        window.location.href = 'index.html';
        return;
      }

      // Load all players
      allPlayers = getPlayers();
      
      // Load admitted players for this tournament
      const admittedPlayers = getAdmittedPlayers();
      const tournamentKey = currentTournament.tournamentId;
      admittedPlayersList = admittedPlayers[tournamentKey] || [];

      renderTournamentHeader();
      renderPlayerList();
      updateStats();
      setupSearch();
    }

    function renderTournamentHeader() {
      document.getElementById('tournament-name').textContent = currentTournament.name;
      document.getElementById('tournament-date').textContent = formatDate(currentTournament.date);
      document.getElementById('tournament-format').textContent = 
        `${currentTournament.gameFormat} - ${currentTournament.matchFormat || '18'} holes`;
      
      // Get course name
      const courses = getCourses();
      const course = courses.find(c => (c.courseId || c.courseName) === currentTournament.course);
      document.getElementById('tournament-course').textContent = course ? course.courseName : currentTournament.course;
      
      document.getElementById('bracket-size').textContent = currentTournament.bracketSize || 64;
      document.getElementById('bracket-size-select').value = currentTournament.bracketSize || 64;
      document.getElementById('stat-bracket-slots').textContent = currentTournament.bracketSize || 64;
    }

    function renderPlayerList() {
      const container = document.getElementById('player-list');
      container.innerHTML = '';

      // Filter: show only admitted players, or all players if none admitted
      let playersToShow = admittedPlayersList.length > 0 
        ? allPlayers.filter(p => admittedPlayersList.some(ap => ap.playerId === p.playerId))
        : allPlayers;

      if (playersToShow.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">No players available. Use Admissions to add players first.</p>';
        return;
      }

      playersToShow.forEach(player => {
        const isSelected = selectedPlayers.some(p => p.playerId === player.playerId);
        const div = document.createElement('div');
        div.className = 'player-item' + (isSelected ? ' selected' : '');
        div.innerHTML = `
          <div class="player-name">${player.name} ${player.surname}</div>
          <div class="player-details">HCP: ${player.handicap || 'N/A'} | Gender: ${player.gender || 'N/A'}</div>
        `;
        div.addEventListener('click', () => togglePlayer(player));
        container.appendChild(div);
      });
    }

    function togglePlayer(player) {
      const index = selectedPlayers.findIndex(p => p.playerId === player.playerId);
      
      if (index > -1) {
        // Remove player
        selectedPlayers.splice(index, 1);
      } else {
        // Add player
        selectedPlayers.push(player);
      }
      
      renderPlayerList();
      renderSeedingList();
      updateStats();
    }

    function renderSeedingList() {
      const container = document.getElementById('seeding-list');
      
      if (selectedPlayers.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:40px 0;">No players selected yet. Click players from the left panel to add them.</p>';
        return;
      }

      container.innerHTML = '';
      selectedPlayers.forEach((player, index) => {
        const div = document.createElement('div');
        div.className = 'seeding-item';
        div.innerHTML = `
          <div class="seed-number">#${index + 1}</div>
          <div style="flex:1;">
            <div class="player-name">${player.name} ${player.surname}</div>
            <div class="player-details">HCP: ${player.handicap || 'N/A'}</div>
          </div>
          ${index > 0 ? '<button class="btn-move" onclick="movePlayer(' + index + ', -1)">‚Üë</button>' : ''}
          ${index < selectedPlayers.length - 1 ? '<button class="btn-move" onclick="movePlayer(' + index + ', 1)">‚Üì</button>' : ''}
          <button class="btn-remove" onclick="removePlayer(' + index + ')">Remove</button>
        `;
        container.appendChild(div);
      });
    }

    function movePlayer(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= selectedPlayers.length) return;
      
      const temp = selectedPlayers[index];
      selectedPlayers[index] = selectedPlayers[newIndex];
      selectedPlayers[newIndex] = temp;
      
      renderSeedingList();
    }

    function removePlayer(index) {
      selectedPlayers.splice(index, 1);
      renderPlayerList();
      renderSeedingList();
      updateStats();
    }

    function applySeedingMethod() {
      const method = document.getElementById('seeding-method').value;
      
      if (selectedPlayers.length === 0) {
        alert('No players selected. Please select players first.');
        return;
      }

      if (method === 'handicap') {
        // Sort by handicap (lowest first)
        selectedPlayers.sort((a, b) => {
          const hcpA = parseFloat(a.handicap) || 999;
          const hcpB = parseFloat(b.handicap) || 999;
          return hcpA - hcpB;
        });
      } else if (method === 'random') {
        // Shuffle randomly
        for (let i = selectedPlayers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [selectedPlayers[i], selectedPlayers[j]] = [selectedPlayers[j], selectedPlayers[i]];
        }
      }
      // manual = do nothing
      
      renderSeedingList();
    }

    function updateStats() {
      const bracketSize = parseInt(document.getElementById('bracket-size-select').value);
      const selectedCount = selectedPlayers.length;
      
      document.getElementById('stat-selected').textContent = selectedCount;
      document.getElementById('stat-bracket-slots').textContent = bracketSize;
      
      // Calculate qualifying matches and byes
      let qualifyingMatches = 0;
      let byes = 0;
      
      if (selectedCount > bracketSize) {
        // Need qualifying matches
        qualifyingMatches = selectedCount - bracketSize;
      } else if (selectedCount < bracketSize) {
        // Need byes
        byes = bracketSize - selectedCount;
      }
      
      document.getElementById('stat-qualifying').textContent = qualifyingMatches;
      document.getElementById('stat-byes').textContent = byes;
    }

    // Update stats when bracket size changes
    document.getElementById('bracket-size-select').addEventListener('change', updateStats);

    function setupSearch() {
      const searchInput = document.getElementById('player-search');
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.player-item');
        
        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(query) ? 'flex' : 'none';
        });
      });
    }

    async function generateBracket() {
      if (selectedPlayers.length === 0) {
        alert('Please select at least 2 players to create a bracket.');
        return;
      }

      if (selectedPlayers.length < 2) {
        alert('You need at least 2 players to create a bracket.');
        return;
      }

      const bracketSize = parseInt(document.getElementById('bracket-size-select').value);
      
      if (!confirm(`Generate bracket with ${selectedPlayers.length} players?\n\nBracket Size: ${bracketSize}\nThis will create the bracket structure.`)) {
        return;
      }

      // Update tournament with bracket data
      const tournaments = getTournaments();
      const index = tournaments.findIndex(t => t.tournamentId === currentTournament.tournamentId);
      
      if (index === -1) {
        alert('Tournament not found');
        return;
      }

      // Store bracket configuration
      tournaments[index].bracketSize = bracketSize;
      tournaments[index].meta = tournaments[index].meta || {};
      tournaments[index].meta.bracket = {
        targetSize: bracketSize,
        status: 'ready',
        selectedPlayers: selectedPlayers.map(p => ({
          playerId: p.playerId,
          name: p.name,
          surname: p.surname,
          handicap: p.handicap,
          gender: p.gender
        })),
        seedingMethod: document.getElementById('seeding-method').value,
        createdAt: new Date().toISOString()
      };

      saveTournaments(tournaments);

      // Sync to Firebase
      try {
        if (typeof syncToFirebase !== 'undefined' && syncEnabled) {
          await syncToFirebase('tournaments', tournaments);
          console.log('‚úì Bracket configuration synced to Firebase');
        }
      } catch(e) {
        console.log('Firebase sync error:', e);
      }

      alert('Bracket configured successfully!\n\nYou can now use the Bracket Management page to create matches.');
      window.location.href = 'bracket.html?tournamentId=' + currentTournament.tournamentId;
    }

    // Initialize on page load
    init();
  </script>
</body>
</html>
