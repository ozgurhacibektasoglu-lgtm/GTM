<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Debug Storage</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 1200px; margin: 0 auto; }
    pre { background: #f5f5f5; padding: 15px; overflow: auto; border-radius: 8px; max-height: 400px; }
    button { padding: 10px 20px; margin: 10px 5px 10px 0; cursor: pointer; }
    .danger { background: #dc2626; color: white; border: none; border-radius: 6px; }
    .primary { background: #0b6efd; color: white; border: none; border-radius: 6px; }
    .success { background: #16a34a; color: white; border: none; border-radius: 6px; }
    .warning { background: #f59e0b; color: white; border: none; border-radius: 6px; }
    h2 { margin-top: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
    .status { padding: 10px; border-radius: 6px; margin: 10px 0; }
    .status.ok { background: #dcfce7; color: #166534; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.warning { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>
  <h1>üîç Storage Debug Tool</h1>
  
  <div class="status" id="firebase-status">Checking Firebase connection...</div>
  
  <h2>Actions</h2>
  <button class="primary" onclick="loadData()">üîÑ Refresh Local Data</button>
  <button class="success" onclick="loadFromFirebase()">‚òÅÔ∏è Load from Firebase</button>
  <button class="warning" onclick="syncToFirebaseAll()">‚¨ÜÔ∏è Merge Local with Firebase</button>
  <button class="danger" onclick="clearAll()">üóëÔ∏è Clear ALL localStorage</button>
  
  <h2>üìä Scores Data (by Tournament Round)</h2>
  <pre id="scores-output"></pre>
  
  <h2>üéØ Admitted Players (by Tournament Round)</h2>
  <pre id="admitted-output"></pre>
  
  <h2>üèÜ Tournaments</h2>
  <pre id="tournaments-output"></pre>
  
  <h2>‚òÅÔ∏è Firebase Scores Data</h2>
  <pre id="firebase-scores-output">Click "Load from Firebase" to check</pre>
  
  <h2>üìÅ All localStorage Keys</h2>
  <pre id="keys-output"></pre>

  <!-- Firebase SDK - load first -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    let db = null;
    
    // Initialize Firebase directly here
    const firebaseConfig = {
      apiKey: "AIzaSyBppPEZ0dSEqMQlPDyvaZb5luol51_7qNM",
      authDomain: "gtm-management-6350e.firebaseapp.com",
      databaseURL: "https://gtm-management-6350e-default-rtdb.firebaseio.com/",
      projectId: "gtm-management-6350e",
      storageBucket: "gtm-management-6350e.firebasestorage.app",
      messagingSenderId: "461806742170",
      appId: "1:461806742170:web:9a2af43d50c0a26718cd23"
    };
    
    function initFirebaseDebug() {
      try {
        if (typeof firebase === 'undefined') {
          throw new Error('Firebase SDK not loaded');
        }
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.database();
        document.getElementById('firebase-status').className = 'status ok';
        document.getElementById('firebase-status').textContent = '‚úì Firebase connected - Ready to sync';
        console.log('Firebase initialized successfully');
      } catch (e) {
        document.getElementById('firebase-status').className = 'status error';
        document.getElementById('firebase-status').textContent = '‚úó Firebase error: ' + e.message;
        console.error('Firebase init error:', e);
      }
    }

    function loadData() {
      // Show all keys
      const keysOutput = document.getElementById('keys-output');
      keysOutput.textContent = `Total keys: ${localStorage.length}\n\n`;
      
      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        keys.push(localStorage.key(i));
      }
      keysOutput.textContent += keys.join('\n') || 'No keys found';

      // Show scores specifically
      const scoresOutput = document.getElementById('scores-output');
      const scoresRaw = localStorage.getItem('scores');
      if (scoresRaw) {
        try {
          const scores = JSON.parse(scoresRaw);
          const roundIds = Object.keys(scores);
          let summary = `Found ${roundIds.length} round(s) with scores:\n\n`;
          
          roundIds.forEach(roundId => {
            const roundScores = scores[roundId];
            const playerCount = Object.keys(roundScores).length;
            const playersWithScores = Object.values(roundScores).filter(s => 
              s.holes && s.holes.some(h => h !== '' && h !== null)
            ).length;
            summary += `üìå ${roundId}: ${playersWithScores}/${playerCount} players have scores\n`;
          });
          
          summary += '\n--- Full Data ---\n';
          summary += JSON.stringify(scores, null, 2);
          scoresOutput.textContent = summary;
        } catch (e) {
          scoresOutput.textContent = 'Error parsing: ' + e.message;
        }
      } else {
        scoresOutput.textContent = '‚ö†Ô∏è No "scores" key found in localStorage';
      }

      // Show admitted players
      const admittedOutput = document.getElementById('admitted-output');
      const admittedRaw = localStorage.getItem('admittedPlayers');
      if (admittedRaw) {
        try {
          const admitted = JSON.parse(admittedRaw);
          const roundIds = Object.keys(admitted);
          let summary = `Found ${roundIds.length} round(s) with admitted players:\n\n`;
          
          roundIds.forEach(roundId => {
            const players = admitted[roundId] || [];
            summary += `üìå ${roundId}: ${players.length} players admitted\n`;
          });
          
          summary += '\n--- Full Data ---\n';
          summary += JSON.stringify(admitted, null, 2);
          admittedOutput.textContent = summary;
        } catch (e) {
          admittedOutput.textContent = 'Error parsing: ' + e.message;
        }
      } else {
        admittedOutput.textContent = '‚ö†Ô∏è No "admittedPlayers" key found in localStorage';
      }

      // Show tournaments
      const tournamentsOutput = document.getElementById('tournaments-output');
      const tournamentsRaw = localStorage.getItem('tournaments');
      if (tournamentsRaw) {
        try {
          const tournaments = JSON.parse(tournamentsRaw);
          let summary = `Found ${tournaments.length} tournament(s):\n\n`;
          
          tournaments.forEach(t => {
            const roundIds = t.meta?.roundIds || [t.tournamentId + '-1'];
            summary += `üìå ${t.tournamentId}: ${t.name} (${roundIds.length} round(s): ${roundIds.join(', ')})\n`;
          });
          
          summary += '\n--- Full Data ---\n';
          summary += JSON.stringify(tournaments, null, 2);
          tournamentsOutput.textContent = summary;
        } catch (e) {
          tournamentsOutput.textContent = 'Error parsing: ' + e.message;
        }
      } else {
        tournamentsOutput.textContent = '‚ö†Ô∏è No "tournaments" key found in localStorage';
      }
    }

    async function loadFromFirebase() {
      if (!db) {
        alert('Firebase not connected. Please refresh the page.');
        return;
      }
      
      const firebaseScoresOutput = document.getElementById('firebase-scores-output');
      firebaseScoresOutput.textContent = 'Loading from Firebase...';
      
      try {
        const snapshot = await db.ref('scores').once('value');
        const scores = snapshot.val();
        
        if (scores) {
          const roundIds = Object.keys(scores);
          let summary = `‚òÅÔ∏è Firebase has ${roundIds.length} round(s) with scores:\n\n`;
          
          roundIds.forEach(roundId => {
            const roundScores = scores[roundId];
            const playerCount = Object.keys(roundScores).length;
            const playersWithScores = Object.values(roundScores).filter(s => 
              s.holes && s.holes.some(h => h !== '' && h !== null)
            ).length;
            summary += `üìå ${roundId}: ${playersWithScores}/${playerCount} players have scores\n`;
          });
          
          summary += '\n--- Full Data ---\n';
          summary += JSON.stringify(scores, null, 2);
          firebaseScoresOutput.textContent = summary;
          
          // Ask to sync to localStorage
          if (confirm('Do you want to restore Firebase scores to localStorage?')) {
            localStorage.setItem('scores', JSON.stringify(scores));
            alert('Scores restored from Firebase!');
            loadData();
          }
        } else {
          firebaseScoresOutput.textContent = '‚ö†Ô∏è No scores found in Firebase';
        }
      } catch (e) {
        firebaseScoresOutput.textContent = 'Error: ' + e.message;
        console.error('Firebase load error:', e);
      }
    }

    async function syncToFirebaseAll() {
      if (!db) {
        alert('Firebase not connected. Please refresh the page.');
        return;
      }
      
      if (!confirm('This will MERGE your local data with Firebase (keeping data from both). Continue?')) {
        return;
      }
      
      const statusEl = document.getElementById('firebase-status');
      statusEl.textContent = 'Merging with Firebase...';
      statusEl.className = 'status warning';
      
      try {
        // Get local data
        const localScores = JSON.parse(localStorage.getItem('scores') || '{}');
        const localAdmitted = JSON.parse(localStorage.getItem('admittedPlayers') || '{}');
        const localTournaments = JSON.parse(localStorage.getItem('tournaments') || '[]');
        const localPlayers = JSON.parse(localStorage.getItem('players') || '[]');
        const localCourses = JSON.parse(localStorage.getItem('courses') || '[]');
        const localDraws = JSON.parse(localStorage.getItem('draws') || '{}');
        
        // Get Firebase data
        const fbScores = (await db.ref('scores').once('value')).val() || {};
        const fbAdmitted = (await db.ref('admittedPlayers').once('value')).val() || {};
        const fbTournaments = (await db.ref('tournaments').once('value')).val() || [];
        const fbPlayers = (await db.ref('players').once('value')).val() || [];
        const fbCourses = (await db.ref('courses').once('value')).val() || [];
        const fbDraws = (await db.ref('draws').once('value')).val() || {};
        
        // Merge scores (keep all rounds from both)
        const mergedScores = { ...fbScores, ...localScores };
        // For rounds that exist in both, keep the one with more players/data
        for (const roundId in fbScores) {
          if (localScores[roundId]) {
            const fbPlayerCount = Object.keys(fbScores[roundId]).length;
            const localPlayerCount = Object.keys(localScores[roundId]).length;
            if (fbPlayerCount > localPlayerCount) {
              mergedScores[roundId] = fbScores[roundId];
            }
          }
        }
        
        // Merge admitted players (keep all rounds from both)
        const mergedAdmitted = { ...fbAdmitted, ...localAdmitted };
        
        // Merge tournaments (combine unique by tournamentId)
        const tournamentMap = {};
        [...(Array.isArray(fbTournaments) ? fbTournaments : []), ...localTournaments].forEach(t => {
          if (t && t.tournamentId) tournamentMap[t.tournamentId] = t;
        });
        const mergedTournaments = Object.values(tournamentMap);
        
        // Merge players (combine unique by reg)
        const playerMap = {};
        [...(Array.isArray(fbPlayers) ? fbPlayers : []), ...localPlayers].forEach(p => {
          if (p && p.reg) playerMap[p.reg] = p;
        });
        const mergedPlayers = Object.values(playerMap);
        
        // Merge courses (combine unique by courseId)
        const courseMap = {};
        [...(Array.isArray(fbCourses) ? fbCourses : []), ...localCourses].forEach(c => {
          if (c && c.courseId) courseMap[c.courseId] = c;
        });
        const mergedCourses = Object.values(courseMap);
        
        // Merge draws
        const mergedDraws = { ...fbDraws, ...localDraws };
        
        console.log('Merged scores rounds:', Object.keys(mergedScores));
        
        // Upload merged data
        await db.ref('scores').set(mergedScores);
        await db.ref('admittedPlayers').set(mergedAdmitted);
        await db.ref('tournaments').set(mergedTournaments);
        await db.ref('players').set(mergedPlayers);
        await db.ref('courses').set(mergedCourses);
        await db.ref('draws').set(mergedDraws);
        
        // Also update localStorage with merged data
        localStorage.setItem('scores', JSON.stringify(mergedScores));
        localStorage.setItem('admittedPlayers', JSON.stringify(mergedAdmitted));
        localStorage.setItem('tournaments', JSON.stringify(mergedTournaments));
        localStorage.setItem('players', JSON.stringify(mergedPlayers));
        localStorage.setItem('courses', JSON.stringify(mergedCourses));
        localStorage.setItem('draws', JSON.stringify(mergedDraws));
        
        statusEl.textContent = '‚úì Successfully merged with Firebase!';
        statusEl.className = 'status ok';
        
        alert(`‚úì Merged with Firebase:\n- ${Object.keys(mergedScores).length} score rounds: ${Object.keys(mergedScores).join(', ')}\n- ${Object.keys(mergedAdmitted).length} admission rounds\n- ${mergedTournaments.length} tournaments\n- ${mergedPlayers.length} players\n- ${mergedCourses.length} courses`);
        
        loadData();
      } catch (e) {
        statusEl.textContent = '‚úó Merge failed: ' + e.message;
        statusEl.className = 'status error';
        alert('Error merging with Firebase: ' + e.message);
        console.error('Firebase merge error:', e);
      }
    }

    function clearAll() {
      if (confirm('This will delete ALL data from localStorage. Are you sure?')) {
        localStorage.clear();
        alert('All localStorage cleared!');
        loadData();
      }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', function() {
      initFirebaseDebug();
      loadData();
    });
  </script>
</body>
</html>
