<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Create Match Play Tournament</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
      body{padding-top:70px}
      .form-card{max-width:700px;margin:60px auto;padding:36px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
      .field{margin-bottom:20px}
      label{display:block;font-weight:600;margin-bottom:8px;font-size:15px}
      input[type="text"], select{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px;box-sizing:border-box}
      .help-text{font-size:13px;color:#64748b;margin-top:4px}
      .actions{display:flex;gap:12px;margin-top:24px}
      .btn-primary{background:linear-gradient(180deg,var(--accent),#0a58d1);color:white;border:0;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;flex:1}
      .btn-secondary{background:white;border:1px solid #e6e9ef;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;flex:1;text-decoration:none;text-align:center}
    </style>
  </head>
  <body>
    <div class="top-nav">
      <h1>üèÜ Match Play Tournament</h1>
      <a href="index.html" class="btn-back-top">‚Üê Back</a>
    </div>
    <main class="form-card">
      <p style="color:#64748b;margin-bottom:28px">Configure your match play event details.</p>
      
      <form id="match-form">
        <div class="field">
          <label for="tournament-name">Tournament Name</label>
          <input id="tournament-name" name="name" type="text" required placeholder="e.g. Club Championship Match Play">
        </div>

        <div class="field">
          <label for="start-date">Start Date</label>
          <input id="start-date" name="date" type="date" required>
          <p class="help-text">Tournament start date</p>
        </div>

        <div class="field">
          <label for="course-select">Course</label>
          <select id="course-select" name="course" required>
            <option value="">-- Select course --</option>
          </select>
          <p class="help-text">Primary course for matches</p>
        </div>

        <div class="field">
          <label for="game-format">Game Format</label>
          <select id="game-format" name="gameFormat" required>
            <option value="">-- Select format --</option>
            <option value="singles">Singles</option>
            <option value="fourball">Fourball</option>
            <option value="foursome">Foursome</option>
          </select>
          <p class="help-text">Singles: 1v1 | Fourball: Best ball of 2v2 | Foursome: Alternate shot 2v2</p>
        </div>

        <div class="field">
          <label for="match-type">Match Play Type</label>
          <select id="match-type" name="matchType" required onchange="updateMatchTypeHelp()">
            <option value="">-- Select type --</option>
            <option value="single-event">Single Event Match Play</option>
            <option value="bracket">Bracket Tournament (Elimination)</option>
          </select>
          <p class="help-text" id="match-type-help">Single Event: One-time matches | Bracket: Multi-round elimination tournament</p>
        </div>

        <div class="field" id="bracket-size-field" style="display:none;">
          <label for="bracket-size">Target Bracket Size</label>
          <select id="bracket-size" name="bracketSize">
            <option value="4">4 Players (Semi-finals ‚Üí Final)</option>
            <option value="8">8 Players (Quarter ‚Üí Semi ‚Üí Final)</option>
            <option value="16">16 Players (Round of 16 ‚Üí ... ‚Üí Final)</option>
            <option value="32">32 Players</option>
            <option value="64" selected>64 Players</option>
            <option value="128">128 Players</option>
          </select>
          <p class="help-text">If participants exceed this, qualifying matches will be automatically created</p>
        </div>

        <div class="field" id="tournament-duration-field" style="display:none;">
          <label for="tournament-duration">Tournament Duration</label>
          <select id="tournament-duration" name="duration">
            <option value="single-day">Single Day Event</option>
            <option value="weekend">Weekend (2-3 days)</option>
            <option value="monthly">Monthly (1 month)</option>
            <option value="seasonal" selected>Seasonal (3-6 months)</option>
            <option value="annual">Annual (Year-long)</option>
          </select>
          <p class="help-text">Determines match scheduling flexibility and deadlines</p>
        </div>

        <div class="field">
          <label for="hcp-allowance">HCP Allowance</label>
          <select id="hcp-allowance" name="hcpAllowance" required>
            <option value="100">100%</option>
            <option value="95">95%</option>
            <option value="90">90%</option>
            <option value="85">85%</option>
            <option value="80">80%</option>
            <option value="75">75%</option>
            <option value="50">50%</option>
            <option value="0">0% (Scratch)</option>
          </select>
          <p class="help-text">Percentage of handicap difference applied to matches</p>
        </div>

        <div class="field" id="match-format-field" style="display:none;">
          <label for="match-format">Match Format</label>
          <select id="match-format" name="matchFormat">
            <option value="18">18 Holes</option>
            <option value="36">36 Holes (18+18)</option>
          </select>
          <p class="help-text">Number of holes per match</p>
        </div>

        <div class="actions">
          <button type="submit" class="btn-primary">Continue</button>
        </div>
      </form>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      const editIndexParam = params.get('edit');
      const isEdit = editIndexParam !== null;

      // Update form based on match type selection
      function updateMatchTypeHelp() {
        const matchType = document.getElementById('match-type').value;
        const bracketField = document.getElementById('bracket-size-field');
        const durationField = document.getElementById('tournament-duration-field');
        const formatField = document.getElementById('match-format-field');
        const helpText = document.getElementById('match-type-help');
        
        if (matchType === 'bracket') {
          bracketField.style.display = 'block';
          durationField.style.display = 'block';
          formatField.style.display = 'block';
          helpText.textContent = 'Bracket tournament with elimination rounds. Qualifying matches will be created if needed.';
        } else {
          bracketField.style.display = 'none';
          durationField.style.display = 'none';
          formatField.style.display = 'none';
          helpText.textContent = 'Single Event: One-time matches | Bracket: Multi-round elimination tournament';
        }
      }

      // Load courses
      function loadCourses() {
        const courses = JSON.parse(localStorage.getItem('courses') || '[]');
        const select = document.getElementById('course-select');
        
        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course.courseId || course.courseName;
          const city = course.city && course.city !== 'undefined' ? course.city : '';
          option.textContent = city ? `${course.courseName} (${city})` : course.courseName;
          select.appendChild(option);
        });
      }

      // Set default date to today
      document.getElementById('start-date').valueAsDate = new Date();
      
      // Load courses on page load
      loadCourses();

      // If editing, load tournament data
      if (isEdit) {
        const editIndex = parseInt(editIndexParam, 10);
        const tournaments = getTournaments();
        const tournament = tournaments[editIndex];
        
        if (tournament && tournament.type === 'match') {
          document.getElementById('tournament-name').value = tournament.name || '';
          if (tournament.date) {
            document.getElementById('start-date').value = tournament.date.split('T')[0];
          }
          if (tournament.course) {
            document.getElementById('course-select').value = tournament.course;
          }
          document.getElementById('game-format').value = tournament.gameFormat || '';
          document.getElementById('match-type').value = tournament.matchType || '';
          document.getElementById('hcp-allowance').value = tournament.hcpAllowance || '100';
          
          if (tournament.bracketSize) {
            document.getElementById('bracket-size').value = tournament.bracketSize;
          }
          if (tournament.duration) {
            document.getElementById('tournament-duration').value = tournament.duration;
          }
          if (tournament.matchFormat) {
            document.getElementById('match-format').value = tournament.matchFormat;
          }
          
          updateMatchTypeHelp();
        }
      }

      function getTournaments() {
        try {
          const raw = localStorage.getItem('tournaments');
          return raw ? JSON.parse(raw) : [];
        } catch(e) {
          console.error('Error loading tournaments:', e);
          return [];
        }
      }

      function saveTournaments(list) {
        try {
          localStorage.setItem('tournaments', JSON.stringify(list));
        } catch(e) {
          console.error('Error saving tournaments:', e);
          alert('Error saving tournament: ' + e.message);
        }
      }

      function generateTournamentId() {
        const tournaments = getTournaments();
        let maxNum = 0;
        tournaments.forEach(function(t) {
          const match = (t.tournamentId || '').match(/^T(\d+)$/);
          if (match) {
            maxNum = Math.max(maxNum, parseInt(match[1], 10));
          }
        });
        return 'T' + String(maxNum + 1).padStart(3, '0');
      }

      document.getElementById('match-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('tournament-name').value.trim();
        const startDate = document.getElementById('start-date').value;
        const course = document.getElementById('course-select').value;
        const gameFormat = document.getElementById('game-format').value;
        const matchType = document.getElementById('match-type').value;
        const hcpAllowance = document.getElementById('hcp-allowance').value;

        if (!name || !startDate || !course || !gameFormat || !matchType || !hcpAllowance) {
          alert('Please fill in all required fields.');
          return;
        }

        const now = new Date().toISOString();
        const tournament = {
          tournamentId: isEdit ? getTournaments()[parseInt(editIndexParam, 10)].tournamentId : generateTournamentId(),
          name: name,
          type: 'match',
          date: new Date(startDate).toISOString(),
          course: course,
          gameFormat: gameFormat,
          matchType: matchType,
          hcpAllowance: hcpAllowance,
          createdAt: isEdit ? getTournaments()[parseInt(editIndexParam, 10)].createdAt : now,
          updatedAt: now,
          meta: isEdit ? getTournaments()[parseInt(editIndexParam, 10)].meta : { courses: [course] }
        };

        // Add bracket-specific fields
        if (matchType === 'bracket') {
          tournament.bracketSize = parseInt(document.getElementById('bracket-size').value);
          tournament.duration = document.getElementById('tournament-duration').value;
          tournament.matchFormat = document.getElementById('match-format').value || '18';
          
          // Initialize bracket structure
          if (!isEdit) {
            tournament.meta.bracket = {
              targetSize: tournament.bracketSize,
              status: 'setup', // setup, qualifying, in-progress, completed
              rounds: [],
              qualifyingMatches: []
            };
          }
        }

        const tournaments = getTournaments();
        
        if (isEdit) {
          tournaments[parseInt(editIndexParam, 10)] = tournament;
        } else {
          tournaments.push(tournament);
        }

        saveTournaments(tournaments);

        // Sync to Firebase
        if (typeof syncToFirebase !== 'undefined' && typeof syncEnabled !== 'undefined' && syncEnabled) {
          syncToFirebase('tournaments', tournaments).then(() => {
            console.log('‚úì Tournament synced to Firebase');
          }).catch(e => console.log('Firebase sync failed:', e));
        }

        // Always redirect to tournaments list
        alert(isEdit ? 'Match Play tournament updated successfully!' : 'Match Play tournament created successfully!');
        window.location.href = 'index.html';
      });
    </script>
  </body>
</html>
