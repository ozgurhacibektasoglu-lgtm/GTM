<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scorecards</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
      * { font-family: 'Arial', 'Helvetica', sans-serif; }
      body{padding-top:70px}
      .scorecards-container { max-width: 1200px; margin: 24px auto; padding: 16px; }
      .options-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(2,6,23,0.06); }
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b; }
      .form-group select, .form-group input[type="file"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e6e9ef; font-size: 15px; }
      .logo-preview { margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap; }
      .logo-preview img { max-width: 100px; max-height: 60px; object-fit: contain; border: 1px solid #e6e9ef; border-radius: 6px; padding: 4px; }
      .checkbox-group { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
      .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
      .checkbox-group label { margin: 0; font-weight: 500; cursor: pointer; }
      .btn-generate { background: linear-gradient(180deg, #0b6efd, #0952cc); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 12px; }
      .btn-generate:hover { opacity: 0.9; }
      
      /* Print Styles */
      @media print {
        .scorecards-container { max-width: none; margin: 0; padding: 0; }
        .options-card, .action-buttons { display: none; }
        .scorecard { page-break-after: always; border-radius: 0; }
        .scorecard:last-child { page-break-after: auto; }
      }
      
      /* Scorecard Styling */
      .scorecard { background: white; border: 2px solid #000; margin-bottom: 24px; padding: 16px; border-radius: 12px; font-family: 'Arial', sans-serif; }
      
      .scorecard-top { display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 12px; align-items: start; }
      .scorecard-info { flex: 1; }
      .scorecard-title { font-size: 26px; font-weight: bold; text-align: center; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px; }
      .scorecard-details { font-size: 13px; line-height: 1.6; }
      .scorecard-details div { margin: 2px 0; }
      .scorecard-logos { display: flex; gap: 8px; align-items: center; }
      .scorecard-logos img { max-width: 80px; max-height: 60px; object-fit: contain; }
      
      .scorecard-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 11px; }
      .scorecard-table th { background: #000; color: white; padding: 6px 2px; text-align: center; font-weight: bold; border: 1px solid #000; }
      .scorecard-table td { padding: 6px 2px; text-align: center; border: 1px solid #666; line-height: 1.3; }
      .scorecard-table .row-label { text-align: left; font-weight: bold; background: #f5f5f5; padding-left: 8px; white-space: nowrap; }
      .scorecard-table .total-cell { background: #e8e8e8; font-weight: bold; }
      .scorecard-table .score-box { height: 35px; background: white; }
      .scorecard-table .player-row { background: #e3f2fd; height: 40px; }
      .scorecard-table .marker-row { background: white; height: 40px; }
      .scorecard-table .pace-row { background: white; }
      
      .logos-section { display: flex; justify-content: center; gap: 20px; margin: 12px 0; padding: 8px; }
      .scorecard-logo { max-height: 60px; max-width: 120px; object-fit: contain; }
      
      .player-info-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 12px 0; padding: 12px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd; }
      .player-info-item { display: flex; flex-direction: column; }
      .player-info-label { font-size: 11px; font-weight: bold; color: #666; margin-bottom: 4px; }
      .player-info-value { font-size: 14px; font-weight: 600; color: #000; }
      
      .scorecard-footer { margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; font-size: 12px; }
      .signature-box { display: flex; flex-direction: column; }
      .signature-label { font-weight: bold; margin-bottom: 4px; }
      .signature-line { border-bottom: 1.5px solid #000; padding-bottom: 2px; margin-top: 8px; height: 30px; }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <h1>üèÜ Scorecards</h1>
      <a href="index.html" class="btn-back-top">‚Üê Back</a>
    </div>
    <main class="scorecards-container">
      <header>
        <h1>Generate Scorecards</h1>
        <p class="lead" id="tournament-name">Configure and print scorecards</p>
      </header>

      <div class="options-card" id="options-panel">
        <h2 style="margin-top: 0;">Scorecard Options</h2>
        
        <div class="form-group">
          <label for="round-select">Select Round:</label>
          <select id="round-select">
            <option value="">-- Select Round --</option>
          </select>
        </div>

        <div class="form-group">
          <label for="logo-upload">Upload Logos (optional, up to 3):</label>
          <input type="file" id="logo-upload" accept="image/*" multiple onchange="handleLogoUpload(event)">
          <div class="logo-preview" id="logo-preview"></div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="auto-assign-marker" checked>
          <label for="auto-assign-marker">Auto-assign markers (next player in flight)</label>
        </div>

        <button class="btn-generate" onclick="generateScorecards()">üìù Generate Scorecards</button>
      </div>

      <div id="scorecards-output"></div>

      <div class="action-buttons" id="action-buttons" style="display: none;">
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print Scorecards</button>
        <button class="btn btn-back" onclick="window.location.reload()">üîÑ Back to Options</button>
        <a href="documents.html" id="back-link" class="btn btn-back">Back to Documents</a>
      </div>
    </main>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const tournamentId = urlParams.get('tournamentId');
      
      let tournament = null;
      let courseData = null;
      let uploadedLogos = [];

      function getTournaments() {
        try {
          const raw = localStorage.getItem('tournaments');
          return raw ? JSON.parse(raw) : [];
        } catch (err) {
          console.error('Failed to parse tournaments', err);
          return [];
        }
      }

      function getCourses() {
        try {
          const raw = localStorage.getItem('courses');
          return raw ? JSON.parse(raw) : [];
        } catch (err) {
          console.error('Failed to parse courses', err);
          return [];
        }
      }

      function getDraws() {
        try {
          const raw = localStorage.getItem('draws');
          return raw ? JSON.parse(raw) : {};
        } catch (err) {
          console.error('Failed to parse draws', err);
          return {};
        }
      }

      function getAdmittedPlayers() {
        try {
          const raw = localStorage.getItem('admittedPlayers');
          return raw ? JSON.parse(raw) : {};
        } catch (err) {
          console.error('Failed to parse admittedPlayers', err);
          return {};
        }
      }

      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      }

      // Handle logo uploads
      function handleLogoUpload(event) {
        const files = event.target.files;
        uploadedLogos = [];
        const previewDiv = document.getElementById('logoPreview');
        previewDiv.innerHTML = '';
        
        const maxLogos = Math.min(files.length, 3);
        for (let i = 0; i < maxLogos; i++) {
          const file = files[i];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            uploadedLogos.push(e.target.result);
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '80px';
            img.style.maxHeight = '60px';
            img.style.margin = '5px';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '4px';
            previewDiv.appendChild(img);
          };
          
          reader.readAsDataURL(file);
        }
      }

      function init() {
        const tournaments = getTournaments();
        tournament = tournaments.find(t => t.tournamentId === tournamentId);

        if (!tournament) {
          alert('Tournament not found.');
          window.location.href = 'index.html';
          return;
        }

        document.getElementById('tournament-name').textContent = `Scorecards for ${tournament.name}`;
        document.getElementById('back-link').href = `documents.html?tournamentId=${tournamentId}`;

        console.log('Tournament data:', tournament);

        // Populate round selector
        const roundSelect = document.getElementById('round-select');
        
        // Try to get round IDs from different sources
        let roundIds = tournament.meta?.roundIds;
        
        // Fallback: check if draws exist and use those round IDs
        if (!roundIds || roundIds.length === 0) {
          const draws = getDraws();
          const drawKeys = Object.keys(draws).filter(key => key.startsWith(tournament.tournamentId));
          if (drawKeys.length > 0) {
            roundIds = drawKeys;
          }
        }
        
        // Final fallback: create a default round ID
        if (!roundIds || roundIds.length === 0) {
          roundIds = [tournament.tournamentId + '-1'];
        }

        const roundsData = tournament.meta?.roundsData || [];

        console.log('Round IDs:', roundIds);

        roundIds.forEach((rid, idx) => {
          const option = document.createElement('option');
          option.value = rid;
          
          if (roundsData[idx]) {
            const roundDate = roundsData[idx].date ? formatDate(roundsData[idx].date) : '';
            option.textContent = `Round ${idx + 1}${roundDate ? ' - ' + roundDate : ''}`;
          } else {
            option.textContent = `Round ${idx + 1}`;
          }
          
          roundSelect.appendChild(option);
        });
      }

      function generateScorecards() {
        const roundId = document.getElementById('round-select').value;
        const autoAssignMarker = document.getElementById('auto-assign-marker').checked;

        if (!roundId) {
          alert('Please select a round');
          return;
        }

        // Load course data for this round
        const courses = getCourses();
        const roundIndex = tournament.meta?.roundIds?.indexOf(roundId) || 0;
        const roundData = tournament.meta?.roundsData?.[roundIndex];
        
        // Try to get course from round data, or fallback to tournament-level course
        let courseId = roundData?.course || tournament.courseId || tournament.course;
        
        if (!courseId) {
          alert('Course not configured for this tournament/round');
          return;
        }

        courseData = courses.find(c => c.courseId === courseId);

        if (!courseData || !courseData.pars) {
          alert(`Course data not available (Course ID: ${courseId}). Please ensure the course is added in the Courses section.`);
          return;
        }

        // Get players for this round
        const admittedPlayers = getAdmittedPlayers();
        const roundPlayers = admittedPlayers[roundId] || [];

        if (roundPlayers.length === 0) {
          alert('No players admitted for this round');
          return;
        }

        // Get draws for marker assignment
        const draws = getDraws();
        const roundDraw = draws[roundId] || [];

        // Get round date (roundIndex already declared above)
        const roundDate = tournament.meta?.roundsData?.[roundIndex]?.date || '';

        // Generate scorecards
        let html = '';
        
        roundPlayers.forEach((player, index) => {
          let markerName = '';
          
          if (autoAssignMarker) {
            // Find player's flight
            const flight = roundDraw.find(f => 
              f.players?.some(p => p.reg === player.reg)
            );
            
            if (flight && flight.players) {
              // Find player's index in flight
              const playerIndex = flight.players.findIndex(p => p.reg === player.reg);
              // Assign next player as marker (wrap around)
              const markerIndex = (playerIndex + 1) % flight.players.length;
              const marker = flight.players[markerIndex];
              markerName = `${marker.firstName} ${marker.lastName}`;
            }
          }

          html += generateScorecardHTML(player, markerName, roundDate);
        });

        document.getElementById('scorecards-output').innerHTML = html;
        document.getElementById('options-panel').style.display = 'none';
        document.getElementById('action-buttons').style.display = 'flex';
      }

      function generateScorecardHTML(player, markerName, roundDate) {
        const pars = courseData.pars || [];
        const strokeIndexes = courseData.strokeIndexes || Array(18).fill('-');
        const meters = courseData.distances || Array(18).fill('-');
        
        // Calculate front 9 and back 9 par
        let front9Par = 0, back9Par = 0;
        for (let i = 0; i < 9 && i < pars.length; i++) {
          front9Par += pars[i];
        }
        for (let i = 9; i < 18 && i < pars.length; i++) {
          back9Par += pars[i];
        }
        const totalPar = front9Par + back9Par;

        // Calculate total meters
        let front9Meters = 0, back9Meters = 0;
        for (let i = 0; i < 9 && i < meters.length; i++) {
          front9Meters += (typeof meters[i] === 'number' ? meters[i] : 0);
        }
        for (let i = 9; i < 18 && i < meters.length; i++) {
          back9Meters += (typeof meters[i] === 'number' ? meters[i] : 0);
        }
        const totalMeters = front9Meters + back9Meters;

        // Format HCP and PHCP
        let hcpDisplay = '-';
        if (player.hcp !== undefined && player.hcp !== null && player.hcp !== '') {
          const hcp = parseFloat(player.hcp);
          hcpDisplay = hcp < 0 ? '+' + Math.abs(hcp).toFixed(1) : hcp.toFixed(1);
        }

        let phcpDisplay = '-';
        if (player.phcp !== undefined && player.phcp !== null && player.phcp !== '') {
          phcpDisplay = player.phcp < 0 ? '+' + Math.abs(player.phcp) : player.phcp;
        }

        // Course rating and slope
        const courseRating = courseData.courseRating || '-';
        const slopeRating = courseData.slopeRating || '-';
        const teeName = courseData.teeName || 'White';

        let html = `
          <div class="scorecard">
            <div class="scorecard-top">
              <div class="top-left">
                <div><strong>Tournament:</strong> ${tournament.name}</div>
                <div><strong>Date:</strong> ${roundDate ? formatDate(roundDate) : '-'}</div>
                <div><strong>Course:</strong> ${courseData.courseName || 'Golf Course'}</div>
                <div><strong>Tee:</strong> ${teeName}</div>
              </div>
              <div class="top-right">
                <div><strong>Rating:</strong> ${courseRating}</div>
                <div><strong>Slope:</strong> ${slopeRating}</div>
              </div>
            </div>`;
        
        // Add logos if uploaded
        if (uploadedLogos.length > 0) {
          html += `<div class="logos-section">`;
          uploadedLogos.forEach(logoUrl => {
            html += `<img src="${logoUrl}" alt="Logo" class="scorecard-logo">`;
          });
          html += `</div>`;
        }

        html += `
            <div class="player-info-row">
              <div class="player-info-item">
                <span class="player-info-label">PLAYER NAME</span>
                <span class="player-info-value">${player.firstName} ${player.lastName}</span>
              </div>
              <div class="player-info-item">
                <span class="player-info-label">REG #</span>
                <span class="player-info-value">${player.reg}</span>
              </div>
              <div class="player-info-item">
                <span class="player-info-label">HCP</span>
                <span class="player-info-value">${hcpDisplay}</span>
              </div>
              <div class="player-info-item">
                <span class="player-info-label">PHCP</span>
                <span class="player-info-value">${phcpDisplay}</span>
              </div>
            </div>

            <table class="scorecard-table">
              <thead>
                <tr>
                  <th style="width: 80px;">HOLE</th>`;
        
        // Front 9 holes
        for (let i = 1; i <= 9; i++) {
          html += `<th>${i}</th>`;
        }
        html += `<th class="total-cell">OUT</th>`;
        
        // Back 9 holes
        for (let i = 10; i <= 18; i++) {
          html += `<th>${i}</th>`;
        }
        html += `<th class="total-cell">IN</th>`;
        html += `<th class="total-cell">TOT</th>`;
        html += `</tr></thead><tbody>`;

        // Calculate stroke allocation based on PHCP
        const phcp = parseInt(player.phcp) || 0;
        const strokeAllocation = Array(18).fill(0);
        
        for (let stroke = 1; stroke <= Math.abs(phcp); stroke++) {
          for (let hole = 0; hole < 18; hole++) {
            const si = strokeIndexes[hole];
            if (si === stroke) {
              strokeAllocation[hole]++;
              break;
            }
          }
        }

        // Par row with dots
        html += `<tr><td class="row-label">PAR</td>`;
        for (let i = 0; i < 9 && i < pars.length; i++) {
          const dots = '‚óè'.repeat(strokeAllocation[i]);
          html += `<td>${pars[i]}${dots ? '<br><span style="font-size:10px;color:#0b6efd;">' + dots + '</span>' : ''}</td>`;
        }
        html += `<td class="total-cell">${front9Par}</td>`;
        for (let i = 9; i < 18 && i < pars.length; i++) {
          const dots = '‚óè'.repeat(strokeAllocation[i]);
          html += `<td>${pars[i]}${dots ? '<br><span style="font-size:10px;color:#0b6efd;">' + dots + '</span>' : ''}</td>`;
        }
        html += `<td class="total-cell">${back9Par}</td>`;
        html += `<td class="total-cell">${totalPar}</td>`;
        html += `</tr>`;

        // Meters row
        html += `<tr><td class="row-label">METERS</td>`;
        for (let i = 0; i < 9 && i < meters.length; i++) {
          html += `<td>${meters[i] || '-'}</td>`;
        }
        html += `<td class="total-cell">${front9Meters || '-'}</td>`;
        for (let i = 9; i < 18 && i < meters.length; i++) {
          html += `<td>${meters[i] || '-'}</td>`;
        }
        html += `<td class="total-cell">${back9Meters || '-'}</td>`;
        html += `<td class="total-cell">${totalMeters || '-'}</td>`;
        html += `</tr>`;

        // Stroke Index row
        html += `<tr><td class="row-label">STR.INDX</td>`;
        for (let i = 0; i < 9 && i < strokeIndexes.length; i++) {
          html += `<td>${strokeIndexes[i]}</td>`;
        }
        html += `<td class="total-cell">-</td>`;
        for (let i = 9; i < 18 && i < strokeIndexes.length; i++) {
          html += `<td>${strokeIndexes[i]}</td>`;
        }
        html += `<td class="total-cell">-</td>`;
        html += `<td class="total-cell">-</td>`;
        html += `</tr>`;

        // Player Score row (empty boxes)
        html += `<tr class="player-row"><td class="row-label">PLAYER</td>`;
        for (let i = 0; i < 9; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        for (let i = 9; i < 18; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        html += `<td class="score-box total-cell"></td>`;
        html += `</tr>`;

        // Marker Score row (empty boxes)
        html += `<tr class="marker-row"><td class="row-label">MARKER</td>`;
        for (let i = 0; i < 9; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        for (let i = 9; i < 18; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        html += `<td class="score-box total-cell"></td>`;
        html += `</tr>`;

        // Pace of Play row (empty boxes)
        html += `<tr class="pace-row"><td class="row-label">PACE</td>`;
        for (let i = 0; i < 9; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        for (let i = 9; i < 18; i++) {
          html += `<td class="score-box"></td>`;
        }
        html += `<td class="score-box total-cell"></td>`;
        html += `<td class="score-box total-cell"></td>`;
        html += `</tr>`;

        html += `</tbody></table>`;

        // Signature footer
        html += `
          <div class="scorecard-footer">
            <div class="signature-box">
              <div class="signature-label">Player Signature:</div>
              <div class="signature-line">_______________________________</div>
            </div>
            <div class="signature-box">
              <div class="signature-label">Marker: ${markerName || '_______________________________'}</div>
              <div class="signature-line">_______________________________</div>
            </div>
          </div>
        </div>`; // close scorecard

        return html;
      }

      init();
    </script>
  </body>
</html>
