<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tournaments</title>
    
    <link rel="stylesheet" href="../styles.css">
    <style>
      body { margin: 0; padding: 0; }
      
      /* Top Navigation Bar */
      .top-nav {
        background: linear-gradient(135deg, #0b6efd 0%, #0a58d1 100%);
        padding: 16px 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .top-nav h1 {
        margin: 0;
        color: white;
        font-size: 24px;
        font-weight: 700;
      }
      
      .btn-back-top {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-block;
      }
      
      .btn-back-top:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-1px);
      }
      
      /* Action Buttons - Below Header */
      .action-buttons-container {
        background: #f8fafc;
        padding: 16px 24px;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 60px; /* Height of top-nav */
        z-index: 99;
      }
      
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      
      .tournaments-container { max-width: 1200px; margin: 24px auto; padding: 24px; padding-top: 16px; }
      .table-wrapper { background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.06); margin-bottom: 24px; overflow: hidden; }
      .table-scroll { max-height: calc(100vh - 280px); overflow-y: auto; }
      table { width: 100%; border-collapse: collapse; }
      thead { position: sticky; top: 0; z-index: 10; }
      th { background: #f3f4f6; font-weight: 600; text-align: left; padding: 12px 16px; border-bottom: 2px solid #e5e7eb; }
      th.sortable { cursor: pointer; user-select: none; }
      th .sort-indicator { margin-left: 8px; font-size: 12px; color: #475569 }
      td { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; }
      tr { cursor: pointer; }
      tr.selected { background: #dbeafe; }
      tbody tr:hover { background: #f0f9ff; }
      .btn { background: linear-gradient(180deg, var(--accent), #0a58d1); color: white; border: 0; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: transform 0.08s; flex: 0 0 calc((100% - 60px) / 7); }
      .btn:active { transform: translateY(1px); }
      .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
      .modal-overlay.active{display:flex}
      .modal-content{background:white;border-radius:12px;padding:24px;max-width:400px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
      .modal-content h2{margin-top:0;font-size:20px;color:#1e293b}
      .modal-content label{display:block;font-weight:600;margin-bottom:8px;margin-top:16px}
      .modal-content select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
      .modal-buttons{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}
      .modal-buttons button{padding:10px 20px;border-radius:8px;border:0;cursor:pointer;font-size:14px}
      .modal-buttons .btn-primary{background:linear-gradient(180deg,var(--accent),#0a58d1);color:white}
      .modal-buttons .btn-secondary{background:white;border:1px solid #e6e9ef;color:#333}
      
      /* Year Filter */
      .year-filter { display: flex; align-items: center; gap: 10px; margin-left: auto; }
      .year-filter label { font-weight: 600; color: #475569; font-size: 14px; }
      .year-select { padding: 8px 32px 8px 12px; border: 1px solid #e2e8f0; background: #fff; color: #1e293b; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; min-width: 100px; }
      .year-select:hover { border-color: #cbd5e1; }
      .year-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(11, 110, 253, 0.1); }
      
      /* Row Action Buttons */
      .row-actions { position: relative; }
      .hamburger-btn {
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        transition: all 0.2s;
      }
      .hamburger-btn:hover { background: #e2e8f0; }
      .hamburger-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 180px;
        z-index: 100;
        overflow: hidden;
      }
      .hamburger-menu.active { display: block; }
      .hamburger-menu a, .hamburger-menu button {
        display: block;
        width: 100%;
        padding: 10px 16px;
        text-align: left;
        border: none;
        background: none;
        font-size: 14px;
        color: #1e293b;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.15s;
      }
      .hamburger-menu a:hover, .hamburger-menu button:hover { background: #f1f5f9; }
      .hamburger-menu .menu-divider { height: 1px; background: #e2e8f0; margin: 4px 0; }
      .hamburger-menu .menu-icon { margin-right: 8px; }
    </style>
  </head>
  <body>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../components/auth.js"></script>
    <script>
      // Gate: require authentication; expose current user id and role
      (async function(){
        const { user, role } = await window.Auth.requireAuth();
        window.currentUserId = user.uid;
        window.currentUserRole = role;
        try {
          const profile = await window.Auth.getUserProfile();
          const loginName = profile?.loginName || 'User';
          const topNav = document.querySelector('.top-nav');
          if (topNav){
            const wrap = document.createElement('div');
            wrap.style.display = 'flex';
            wrap.style.alignItems = 'center';
            wrap.style.gap = '12px';
            wrap.style.color = '#fff';
            const badge = document.createElement('span');
            badge.style.fontSize = '12px';
            badge.style.background = 'rgba(255,255,255,0.15)';
            badge.style.padding = '6px 10px';
            badge.style.borderRadius = '999px';
            badge.textContent = `${loginName} ‚Ä¢ ${role}`;
            const back = document.createElement('a');
            back.href = '../index.html';
            back.className = 'btn-back-top';
            back.textContent = '‚Üê Back';
            wrap.appendChild(badge);
            wrap.appendChild(back);
            // Replace existing back button if present
            const existingBack = topNav.querySelector('.btn-back-top');
            if (existingBack){
              existingBack.replaceWith(wrap);
            } else {
              topNav.appendChild(wrap);
            }
          }
        } catch(e){}
      })();
    </script>
    <!-- Top Navigation -->
    <div class="top-nav">
      <h1>üèÜ Tournaments</h1>
      <a href="../index.html" class="btn-back-top">‚Üê Back</a>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons-container">
      <div class="action-buttons">
        <!-- First Row -->
        <div class="button-row">
          <button class="btn" id="btn-new-tournament">New Tournament</button>
          <button class="btn" id="btn-admissions">Admissions</button>
          <button class="btn" id="btn-categories">Categories</button>
          <button class="btn" id="btn-draw">Draw</button>
          <button class="btn" id="btn-documents">Documents</button>
          <button class="btn" id="btn-scores">Scores</button>
          <button class="btn" id="btn-results">Results</button>
        </div>
        <!-- Second Row -->
        <div class="button-row">
          <button class="btn" id="btn-modify-tournament">Modify Tournament</button>
          <button class="btn" id="btn-define-teams">Define Teams</button>
          <button class="btn" id="btn-rankings" style="background: linear-gradient(180deg, #f59e0b, #d97706);">üèÜ Rankings</button>
          <button class="btn" id="btn-pairings" style="display: none;">Pairings</button>
          <button class="btn" id="btn-live-scoring" style="background: linear-gradient(180deg, #059669, #047857);">üì± Live Scoring</button>
          <button class="btn" id="btn-live-leaderboard" style="background: linear-gradient(180deg, #dc2626, #991b1b);">üìä Live Leaderboard</button>
          <button class="btn" id="btn-delete-tournament" style="background: linear-gradient(180deg, #64748b, #475569);">Delete Tournament</button>
          <!-- Year Filter -->
          <div class="year-filter">
            <label for="yearSelect">Year:</label>
            <select class="year-select" id="yearSelect">
              <!-- Years will be populated dynamically -->
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Round Selection Modal -->
    <div id="round-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Select Round</h2>
        <p>This is a multi-day tournament. Please select which round you want to manage admissions for:</p>
        <label for="modal-round-select">Round:</label>
        <select id="modal-round-select">
        </select>
        <div class="modal-buttons">
          <button class="btn-secondary" id="modal-cancel">Cancel</button>
          <button class="btn-primary" id="modal-confirm">Continue</button>
        </div>
      </div>
    </div>

    <!-- Pairings Round Selection Modal -->
    <div id="pairings-round-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Select Round for Pairings</h2>
        <p>Select which fourball/foursome round you want to manage pairings for:</p>
        <label for="pairings-round-select">Round:</label>
        <select id="pairings-round-select">
          <!-- Populated dynamically -->
        </select>
        <div class="modal-buttons">
          <button class="btn-secondary" id="pairings-modal-cancel">Cancel</button>
          <button class="btn-primary" id="pairings-modal-confirm">Continue</button>
        </div>
      </div>
    </div>

    <!-- Draw List Round Selection Modal -->
    <div id="draw-list-round-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Select Round for Draw List</h2>
        <p>This tournament has multiple rounds. Please select which round's draw list to view:</p>
        <label for="draw-list-round-select">Round:</label>
        <select id="draw-list-round-select">
          <!-- Populated dynamically -->
        </select>
        <div class="modal-buttons">
          <button class="btn-secondary" id="draw-list-modal-cancel">Cancel</button>
          <button class="btn-primary" id="draw-list-modal-confirm">View Draw List</button>
        </div>
      </div>
    </div>

    <main class="tournaments-container">
      <div class="table-wrapper">
        <div class="table-scroll">
        <table id="tournaments-table">
          <thead>
              <tr>
                <th data-key="tournamentId" style="width:90px">Tur. ID <span class="sort-indicator"></span></th>
                <th data-key="date">Date <span class="sort-indicator"></span></th>
                <th data-key="name">Tournament Name <span class="sort-indicator"></span></th>
                <th data-key="rounds">Rounds <span class="sort-indicator"></span></th>
                <th data-key="courses">Courses <span class="sort-indicator"></span></th>
                <th data-key="type">Tournament Type <span class="sort-indicator"></span></th>
                <th style="width: 60px;">Actions</th>
              </tr>
          </thead>
          <tbody id="tournaments-body">
            <!-- Rows will be inserted here by JavaScript -->
          </tbody>
        </table>
        </div>
      </div>
    </main>

    <script>

      // Local tournament functions with Firebase sync
      function getTournaments() {
        try {
          const raw = localStorage.getItem('tournaments');
          return raw ? JSON.parse(raw) : [];
        } catch (err) {
          console.error('Failed to parse tournaments from localStorage', err);
          return [];
        }
      }

      function saveTournaments(tournaments) {
        localStorage.setItem('tournaments', JSON.stringify(tournaments || []));
        // Sync to Firebase
        if (typeof syncToFirebase !== 'undefined') {
          syncToFirebase('tournaments', tournaments || []).then(() => {
            console.log('‚úì Tournaments synced to Firebase');
          }).catch(e => console.log('Firebase sync failed:', e));
        }
      }

      let selectedTournamentIndex = null;
      let selectedTournamentOrigIndex = null;
      let selectedYear = new Date().getFullYear(); // Default to current year

      // Get year from date string
      function getYear(dateStr) {
        if (!dateStr) return null;
        try {
          return new Date(dateStr).getFullYear();
        } catch (e) {
          return null;
        }
      }

      // Render year dropdown
      function renderYearTabs(tournaments) {
        const select = document.getElementById('yearSelect');
        const currentYear = new Date().getFullYear();
        
        // Get unique years from tournaments
        const years = new Set();
        years.add(currentYear); // Always include current year
        
        tournaments.forEach(t => {
          const year = getYear(t.date);
          if (year) years.add(year);
        });
        
        const sortedYears = Array.from(years).sort((a, b) => b - a); // Descending
        
        // Only update if the options have changed
        const currentOptions = Array.from(select.options).map(o => o.value);
        const newOptions = sortedYears.map(y => String(y));
        
        if (JSON.stringify(currentOptions) !== JSON.stringify(newOptions)) {
          select.innerHTML = '';
          sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === selectedYear) option.selected = true;
            select.appendChild(option);
          });
        }
        
        // Add change listener (only once)
        if (!select.hasAttribute('data-listener')) {
          select.setAttribute('data-listener', 'true');
          select.addEventListener('change', (e) => {
            selectedYear = parseInt(e.target.value, 10);
            loadTournaments();
          });
        }
      }

      // Format date as dd.mm.yyyy
      function formatDateDDMMYYYY(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}.${month}.${year}`;
      }
      // sort state: key includes 'rounds'
      let sortState = { key: 'date', dir: 'desc' };

      function loadTournaments() {
        const tbody = document.getElementById('tournaments-body');
        tbody.innerHTML = '';

        let tournaments = getTournaments();
        
        // Filter by owner for non-admin users
        try {
          const role = window.currentUserRole;
          const uid = window.currentUserId;
          
          if (role !== 'admin') {
            // Show only tournaments created by this user
            // Hide old tournaments without createdBy field (they belong to admin or pre-auth era)
            tournaments = (tournaments || []).filter(t => t && t.createdBy && (t.createdBy === uid));
          }
        } catch(e) {
          console.error('Error filtering tournaments:', e);
        }

        // Generate year tabs from all tournaments (before year filtering)
        renderYearTabs(tournaments);

        // Filter by selected year
        tournaments = tournaments.filter(t => {
          const year = getYear(t.date);
          return year === selectedYear;
        });

        // attach original index so we can map back to storage after sorting
        const augmented = tournaments.map((t, idx) => Object.assign({ _origIndex: idx }, t));

        // sort according to sortState
        augmented.sort((a, b) => {
          const key = sortState.key;
          let va = a[key];
          let vb = b[key];

          if (key === 'date') {
            va = va ? new Date(va) : new Date(0);
            vb = vb ? new Date(vb) : new Date(0);
            return sortState.dir === 'asc' ? va - vb : vb - va;
          }

          if (key === 'rounds') {
            va = (a.meta && a.meta.rounds) ? parseInt(a.meta.rounds,10) : (a.meta && Array.isArray(a.meta.roundsData) ? a.meta.roundsData.length : 1);
            vb = (b.meta && b.meta.rounds) ? parseInt(b.meta.rounds,10) : (b.meta && Array.isArray(b.meta.roundsData) ? b.meta.roundsData.length : 1);
            return sortState.dir === 'asc' ? va - vb : vb - va;
          }
          if (key === 'courses') {
            va = buildCoursesDisplay(a).toLowerCase();
            vb = buildCoursesDisplay(b).toLowerCase();
            if (va < vb) return sortState.dir === 'asc' ? -1 : 1;
            if (va > vb) return sortState.dir === 'asc' ? 1 : -1;
            return 0;
          }

          // string compare for other keys
          va = (va || '').toString().toLowerCase();
          vb = (vb || '').toString().toLowerCase();
          if (va < vb) return sortState.dir === 'asc' ? -1 : 1;
          if (va > vb) return sortState.dir === 'asc' ? 1 : -1;
          return 0;
        });

        if (tournaments.length === 0) {
          const row = tbody.insertRow();
          row.innerHTML = '<td colspan="7" style="text-align: center; color: #6b7280;">No tournaments to display. Create a new one or contact admin.</td>';
          return;
        }

        augmented.forEach((t, index) => {
          const row = tbody.insertRow();
          // Display simplified ID: remove user prefix (e.g., "KLA-T0001" -> "T0001")
          const tournamentId = t.tournamentId || '-';
          const displayId = tournamentId.includes('-') ? tournamentId.split('-')[1] : tournamentId;
          const roundsCount = (t.meta && t.meta.rounds) ? parseInt(t.meta.rounds,10) : (t.meta && Array.isArray(t.meta.roundsData) ? t.meta.roundsData.length : 1);
          const displayDate = formatTournamentDate(t);
          const coursesDisplay = buildCoursesDisplay(t);
          const displayType = formatTournamentType(t);
          const isBracket = t.type && t.type.toLowerCase().includes('bracket');
          
          // Build hamburger menu options
          let menuItems = `
            <button onclick="openTourInfo(event, '${escapeHtml(t.tournamentId)}')"><span class="menu-icon">‚ÑπÔ∏è</span>Tournament Info</button>
            <button onclick="openOnlineAdmissions(event, '${escapeHtml(t.tournamentId)}')"><span class="menu-icon">üìù</span>Online Admissions</button>
            <button onclick="openDrawList(event, '${escapeHtml(t.tournamentId)}')"><span class="menu-icon">üìã</span>Draw List</button>
            <button onclick="openResults(event, '${escapeHtml(t.tournamentId)}')"><span class="menu-icon">üìä</span>Results</button>
          `;
          if (isBracket) {
            menuItems += `<button onclick="openBracket(event, '${escapeHtml(t.tournamentId)}')"><span class="menu-icon">üèÜ</span>Bracket</button>`;
          }
          
          row.innerHTML = `<td>${escapeHtml(displayId)}</td><td>${displayDate}</td><td>${escapeHtml(t.name)}</td><td>${roundsCount}</td><td>${escapeHtml(coursesDisplay)}</td><td>${escapeHtml(displayType)}</td><td class="row-actions"><button class="hamburger-btn" onclick="toggleHamburgerMenu(event, this)">‚ò∞</button><div class="hamburger-menu">${menuItems}</div></td>`;
          row.dataset.index = index;
          row.dataset.origIndex = t._origIndex;
          row.dataset.tournamentId = t.tournamentId; // Store actual tournament ID
          row.addEventListener('click', () => selectTournament(index, row));
        });
      }

      const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      function padDay(n){ return String(n).padStart(2,'0'); }
      function formatSingleDate(dateStr){
        if (!dateStr) return '-';
        const dt = new Date(dateStr);
        if (Number.isNaN(dt.getTime())) return '-';
        return `${padDay(dt.getDate())} ${MONTHS[dt.getMonth()]}. ${dt.getFullYear()}`;
      }
      function formatTournamentDate(t){
        if (!t.meta) return '-';
        const roundsData = Array.isArray(t.meta.roundsData) ? t.meta.roundsData.filter(r => r && r.date) : [];
        if (roundsData.length === 0) return formatSingleDate(t.date);
        if (roundsData.length === 1) return formatSingleDate(roundsData[0].date);
        const dates = roundsData.map(r => new Date(r.date)).filter(d => !Number.isNaN(d.getTime())).sort((a,b)=>a-b);
        if (!dates.length) return formatSingleDate(t.date);
        const first = dates[0];
        const last = dates[dates.length-1];
        const sameMonth = first.getMonth() === last.getMonth() && first.getFullYear() === last.getFullYear();
        if (sameMonth){
          return `${padDay(first.getDate())}-${padDay(last.getDate())} ${MONTHS[first.getMonth()]}. ${last.getFullYear()}`;
        }
        const yearDisplay = first.getFullYear() === last.getFullYear() ? last.getFullYear() : `${first.getFullYear()}/${last.getFullYear()}`;
        return `${padDay(first.getDate())} ${MONTHS[first.getMonth()]}. - ${padDay(last.getDate())} ${MONTHS[last.getMonth()]}. ${yearDisplay}`;
      }
      function buildCoursesDisplay(t){
        // For bracket tournaments, course is stored directly in t.course
        let coursesRaw = [];
        if (t.course) {
          coursesRaw = [t.course];
        } else if (t.meta && Array.isArray(t.meta.roundsData)) {
          coursesRaw = t.meta.roundsData.map(r => r.course).filter(Boolean);
        } else if (t.meta && Array.isArray(t.meta.courses)) {
          coursesRaw = t.meta.courses;
        }
        
        if (!coursesRaw.length) return '-';
        const seen = new Set();
        const orderedUnique = [];
        coursesRaw.forEach(c => { const key = c.toLowerCase(); if (!seen.has(key)){ seen.add(key); orderedUnique.push(c); }});
        let storedCourses = [];
        try { const raw = localStorage.getItem('courses'); storedCourses = raw ? JSON.parse(raw) : []; } catch(e) {}
        const mapped = orderedUnique.map(id => {
          const courseObj = storedCourses.find(c => c.courseId === id || c.fullName === id || c.name === id) || {};
          return courseObj.shortName || courseObj.fullName || courseObj.name || id;
        });
        return mapped.join(' / ');
      }
      
      function formatTournamentType(t){
        // If type already includes display info (like "Stroke Play" or "Stroke Play (Teams)"), return as-is
        if (t.type && (t.type.includes('Stroke') || t.type.includes('Match'))) {
          return t.type;
        }
        // Convert internal 'match' type to display name
        if (t.type === 'match') {
          const isTeams = t.meta && t.meta.teamsTournament === 'yes';
          return isTeams ? 'Match Play (Teams)' : 'Match Play';
        }
        return t.type || '-';
      }

      // Simple escape to avoid injecting raw HTML from stored names/types
      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&"'<>]/g, function (s) {
          return ({ '&': '&amp;', '"': '&quot;', "'": '&#39;', '<': '&lt;', '>': '&gt;' })[s];
        });
      }

      // Add click handlers to headers to allow sorting
      function setupSorting() {
        const ths = document.querySelectorAll('#tournaments-table thead th');
        ths.forEach(th => {
          const key = th.dataset.key;
          if (!key) return;
          th.classList.add('sortable');
          th.addEventListener('click', () => {
            if (sortState.key === key) {
              // toggle direction
              sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
              sortState.key = key;
              sortState.dir = 'asc';
            }
            // re-render
            loadTournaments();
            renderSortIndicators();
          });
        });
      }

      function renderSortIndicators() {
        const ths = document.querySelectorAll('#tournaments-table thead th');
        ths.forEach(th => {
          const key = th.dataset.key;
          let ind = th.querySelector('.sort-indicator');
          if (!ind) {
            ind = document.createElement('span');
            ind.className = 'sort-indicator';
            th.appendChild(ind);
          }
          if (key === sortState.key) {
            ind.textContent = sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº';
          } else {
            ind.textContent = '';
          }
        });
      }

      let selectedTournamentId = null; // Store the actual tournament ID instead of index
      
      // Hamburger menu toggle
      function toggleHamburgerMenu(event, btn) {
        event.stopPropagation();
        const menu = btn.nextElementSibling;
        const isActive = menu.classList.contains('active');
        
        // Close all other menus first
        document.querySelectorAll('.hamburger-menu.active').forEach(m => m.classList.remove('active'));
        
        // Toggle this menu
        if (!isActive) {
          menu.classList.add('active');
        }
      }
      
      // Close hamburger menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.row-actions')) {
          document.querySelectorAll('.hamburger-menu.active').forEach(m => m.classList.remove('active'));
        }
      });
      
      // Handler for Tour. Info button
      function openTourInfo(event, tournamentId) {
        event.stopPropagation(); // Prevent row selection
        // Navigate to tournament info page for PDF upload/view
        window.location.href = `info.html?tournamentId=${encodeURIComponent(tournamentId)}`;
      }
      
      // Handler for Bracket button
      function openBracket(event, tournamentId) {
        event.stopPropagation(); // Prevent row selection
        window.location.href = `bracket.html?tournamentId=${encodeURIComponent(tournamentId)}`;
      }
      
      // Handler for Online Admissions button
      function openOnlineAdmissions(event, tournamentId) {
        event.stopPropagation(); // Prevent row selection
        // Navigate to online admissions configuration page
        window.location.href = `online_admissions_config.html?tournamentId=${encodeURIComponent(tournamentId)}`;
      }
      
      // Handler for Draw List button
      function openDrawList(event, tournamentId) {
        event.stopPropagation(); // Prevent row selection
        
        // Get the tournament to check number of rounds
        const tournaments = getTournaments();
        const tournament = tournaments.find(t => t.tournamentId === tournamentId);
        
        if (!tournament) {
          alert('Tournament not found.');
          return;
        }
        
        // Check if tournament has multiple rounds
        const roundsData = tournament.meta?.roundsData || [];
        const roundIds = tournament.meta?.roundIds || [];
        
        if (roundsData.length > 1) {
          // Multi-round tournament - show round selection modal
          const modalSelect = document.getElementById('draw-list-round-select');
          modalSelect.innerHTML = '';
          
          // Store tournament ID for the modal confirm handler
          modalSelect.dataset.tournamentId = tournamentId;
          
          roundsData.forEach((round, idx) => {
            const option = document.createElement('option');
            const roundId = roundIds[idx] || `${tournamentId}_R${idx + 1}`;
            option.value = roundId;
            option.textContent = `Round ${idx + 1}${round.date ? ' - ' + formatDateDDMMYYYY(round.date) : ''}`;
            modalSelect.appendChild(option);
          });
          
          document.getElementById('draw-list-round-modal').classList.add('active');
        } else {
          // Single round - go directly to draw_list.html
          const roundId = roundIds[0] || `${tournamentId}_R1`;
          window.location.href = `draw_list.html?tournamentId=${encodeURIComponent(tournamentId)}&roundId=${encodeURIComponent(roundId)}`;
        }
      }
      
      // Handler for Results button - navigate to results page
      function openResults(event, tournamentId) {
        event.stopPropagation(); // Prevent row selection
        // Navigate directly to results.html for club users
        window.location.href = `results.html?tournamentId=${encodeURIComponent(tournamentId)}`;
      }
      
      function selectTournament(index, row) {
        // Remove previous selection
        document.querySelectorAll('#tournaments-body tr').forEach(r => r.classList.remove('selected'));
        // Add selection to clicked row
        row.classList.add('selected');
        selectedTournamentIndex = index;
        // Store the tournament ID from the row
        selectedTournamentId = row.dataset.tournamentId;
        // also store the original storage index for reliable lookup
        selectedTournamentOrigIndex = parseInt(row.dataset.origIndex, 10);
        
        // Save selected tournament ID to localStorage
        localStorage.setItem('lastSelectedTournamentId', selectedTournamentId);
        
        // Show/hide Pairings button based on fourball/foursome rounds
        updatePairingsButtonVisibility();
      }

      function restoreLastSelection() {
        const lastTournamentId = localStorage.getItem('lastSelectedTournamentId');
        if (!lastTournamentId) return;
        
        const rows = document.querySelectorAll('#tournaments-body tr');
        rows.forEach((row, index) => {
          const tournamentId = row.dataset.tournamentId;
          if (tournamentId === lastTournamentId) {
            selectTournament(index, row);
            row.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }
        });
      }

      // Initialize: Load from Firebase if available
      async function initializeTournaments() {
        // Wait for Firebase to be ready
        let attempts = 0;
        while (!syncEnabled && attempts < 10) {
          await new Promise(resolve => setTimeout(resolve, 200));
          attempts++;
        }
        
        console.log('Initializing tournaments, syncEnabled:', syncEnabled);
        
        // Try to load from Firebase
        if (syncEnabled && typeof loadTournamentsFromFirebase !== 'undefined') {
          try {
            const firebaseTournaments = await loadTournamentsFromFirebase();
            if (firebaseTournaments && firebaseTournaments.length > 0) {
              console.log('‚úì Loaded', firebaseTournaments.length, 'tournaments from Firebase');
            } else {
              console.log('No tournaments found in Firebase, using localStorage');
            }
          } catch(e) {
            console.log('Firebase load failed, using localStorage:', e);
          }
        }
        
        loadTournaments();
        setupSorting();
        renderSortIndicators();
        restoreLastSelection();
      }

      // Wait a moment for Firebase to initialize, then load
      setTimeout(initializeTournaments, 500);

      // Button event listeners
      document.getElementById('btn-new-tournament').addEventListener('click', () => {
        // Go straight to tournament definition; type can be switched there
        window.location.href = 'stroke.html';
      });

      document.getElementById('btn-modify-tournament').addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }
        // Pass tournamentId instead of array index for reliable editing
        window.location.href = `stroke.html?editId=${encodeURIComponent(selectedTournamentId)}`;
      });

      let selectedTournamentForModal = null;

      function closeRoundModal() {
        document.getElementById('round-modal').classList.remove('active');
        selectedTournamentForModal = null;
      }

      function confirmRoundSelection() {
        const roundId = document.getElementById('modal-round-select').value;
        if (selectedTournamentForModal && roundId) {
          window.location.href = `admissions.html?roundId=${encodeURIComponent(roundId)}`;
        }
      }

      document.getElementById('btn-admissions').addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }
        const list = getTournaments();
        const selected = list.find(t => t.tournamentId === selectedTournamentId);
        if (!selected) {
          alert('Selected tournament not found.');
          return;
        }

        // Check if multi-round tournament
        const numRounds = selected.meta?.rounds || 1;
        const roundsData = selected.meta?.roundsData || [];
        const roundIds = selected.meta?.roundIds || [];
        
        if (numRounds > 1 && roundsData.length > 1) {
          // Show modal for round selection
          selectedTournamentForModal = selected;
          const modalSelect = document.getElementById('modal-round-select');
          modalSelect.innerHTML = '';
          
          // Determine default round based on current date
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          let defaultRoundIndex = 0;
          
          for (let i = 0; i < roundsData.length; i++) {
            if (roundsData[i].date) {
              const roundDate = new Date(roundsData[i].date);
              roundDate.setHours(0, 0, 0, 0);
              
              if (today >= roundDate) {
                defaultRoundIndex = i;
              } else {
                break;
              }
            }
          }
          
          roundsData.forEach((round, idx) => {
            const option = document.createElement('option');
            option.value = roundIds[idx] || `${selected.tournamentId}_R${idx + 1}`;
            option.textContent = `Round ${idx + 1}${round.date ? ' - ' + formatDateDDMMYYYY(round.date) : ''}`;
            if (idx === defaultRoundIndex) {
              option.selected = true;
            }
            modalSelect.appendChild(option);
          });
          document.getElementById('round-modal').classList.add('active');
        } else {
          // Single round, go directly
          const roundId = roundIds[0] || `${selected.tournamentId}_R1`;
          window.location.href = `admissions.html?roundId=${encodeURIComponent(roundId)}`;
        }
      });

      document.getElementById('btn-define-teams').addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }
        const list = getTournaments();
        const selected = list.find(t => t.tournamentId === selectedTournamentId);
        if (!selected) {
          alert('Selected tournament not found.');
          return;
        }
        // Check if it's a teams tournament
        const isTeamsTournament = selected.meta?.teamsTournament === 'yes' || 
                                  selected.type?.includes('Teams');
        if (!isTeamsTournament) {
          alert('This is not a teams tournament. Please select a teams tournament or create a new teams tournament first.');
          return;
        }
        // Navigate to teams definition page (to be created)
        window.location.href = `teams.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      // Function to check if tournament has fourball/foursome rounds
      function hasFourballFoursomeRounds(tournament) {
        if (!tournament || !tournament.meta || !tournament.meta.roundsData) {
          return false;
        }
        return tournament.meta.roundsData.some(round => 
          round.matchType === 'fourball' || round.matchType === 'foursomes'
        );
      }

      // Function to get fourball/foursome rounds
      function getFourballFoursomeRounds(tournament) {
        if (!tournament || !tournament.meta || !tournament.meta.roundsData) {
          return [];
        }
        return tournament.meta.roundsData
          .map((round, index) => ({ ...round, roundNumber: index + 1 }))
          .filter(round => round.matchType === 'fourball' || round.matchType === 'foursomes');
      }

      // Function to update Pairings button visibility
      function updatePairingsButtonVisibility() {
        const pairingsBtn = document.getElementById('btn-pairings');
        if (!pairingsBtn) return;
        
        if (!selectedTournamentId) {
          pairingsBtn.style.display = 'none';
          return;
        }
        
        const list = getTournaments();
        const selected = list.find(t => t.tournamentId === selectedTournamentId);
        
        if (selected && hasFourballFoursomeRounds(selected)) {
          pairingsBtn.style.display = '';
        } else {
          pairingsBtn.style.display = 'none';
        }
      }

      // Pairings button click handler (only if button exists)
      const pairingsBtn = document.getElementById('btn-pairings');
      if (pairingsBtn) {
        pairingsBtn.addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }
        const list = getTournaments();
        const selected = list.find(t => t.tournamentId === selectedTournamentId);
        if (!selected) {
          alert('Selected tournament not found.');
          return;
        }

        const pairingRounds = getFourballFoursomeRounds(selected);
        if (pairingRounds.length === 0) {
          alert('This tournament has no fourball or foursome rounds.');
          return;
        }

        if (pairingRounds.length === 1) {
          // Direct navigation if only one round
          const roundId = `${selected.tournamentId}-${pairingRounds[0].roundNumber}`;
          window.location.href = `pairings.html?roundId=${encodeURIComponent(roundId)}`;
        } else {
          // Show modal to select round
          const modal = document.getElementById('pairings-round-modal');
          const select = document.getElementById('pairings-round-select');
          select.innerHTML = '';
          
          pairingRounds.forEach(round => {
            const option = document.createElement('option');
            const roundId = `${selected.tournamentId}-${round.roundNumber}`;
            option.value = roundId;
            option.textContent = `Round ${round.roundNumber} - ${round.matchType.charAt(0).toUpperCase() + round.matchType.slice(1)}`;
            select.appendChild(option);
          });
          
          modal.classList.add('active');
        }
        });
      }

      // Pairings modal handlers
      const pairingsModalCancel = document.getElementById('pairings-modal-cancel');
      if (pairingsModalCancel) {
        pairingsModalCancel.addEventListener('click', () => {
          document.getElementById('pairings-round-modal').classList.remove('active');
        });
      }

      const pairingsModalConfirm = document.getElementById('pairings-modal-confirm');
      if (pairingsModalConfirm) {
        pairingsModalConfirm.addEventListener('click', () => {
          const select = document.getElementById('pairings-round-select');
          const roundId = select.value;
          if (roundId) {
            window.location.href = `pairings.html?roundId=${encodeURIComponent(roundId)}`;
          }
        });
      }

      // Draw List round selection modal handlers
      const drawListModalCancel = document.getElementById('draw-list-modal-cancel');
      if (drawListModalCancel) {
        drawListModalCancel.addEventListener('click', () => {
          document.getElementById('draw-list-round-modal').classList.remove('active');
        });
      }

      const drawListModalConfirm = document.getElementById('draw-list-modal-confirm');
      if (drawListModalConfirm) {
        drawListModalConfirm.addEventListener('click', () => {
          const select = document.getElementById('draw-list-round-select');
          const tournamentId = select.dataset.tournamentId;
          const roundId = select.value;
          if (roundId) {
            window.location.href = `draw_list.html?tournamentId=${encodeURIComponent(tournamentId)}&roundId=${encodeURIComponent(roundId)}`;
          }
          document.getElementById('draw-list-round-modal').classList.remove('active');
        });
      }

      // Admissions round selection modal handlers
      document.getElementById('modal-cancel').addEventListener('click', () => {
        closeRoundModal();
      });

      document.getElementById('modal-confirm').addEventListener('click', () => {
        confirmRoundSelection();
      });

      document.getElementById('btn-draw').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.location.href = `draw.html?tournamentId=${selected.tournamentId}`;
      });

      document.getElementById('btn-categories').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.location.href = `categories.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      document.getElementById('btn-scores').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.location.href = `scores_mode.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      document.getElementById('btn-live-scoring').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.location.href = `live_scoring_settings.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      document.getElementById('btn-live-leaderboard').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.open(`live_leaderboard.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`, '_blank');
      });

      document.getElementById('btn-rankings').addEventListener('click', () => {
        window.location.href = 'rankings.html';
      });

      document.getElementById('btn-results').addEventListener('click', () => {
        if (!selectedTournamentId) { alert('Please select a tournament from the table above.'); return; }
        const list = getTournaments(); const selected = list.find(t => t.tournamentId === selectedTournamentId); if (!selected) { alert('Selected tournament not found.'); return; }
        window.location.href = `results.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      document.getElementById('btn-documents').addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }
        const list = getTournaments();
        const selected = list.find(t => t.tournamentId === selectedTournamentId);
        if (!selected) {
          alert('Selected tournament not found.');
          return;
        }
        window.location.href = `documents.html?tournamentId=${encodeURIComponent(selected.tournamentId)}`;
      });

      document.getElementById('btn-delete-tournament').addEventListener('click', () => {
        if (!selectedTournamentId) {
          alert('Please select a tournament from the table above.');
          return;
        }

        const tournaments = getTournaments();
        const actualIndex = tournaments.findIndex(t => t.tournamentId === selectedTournamentId);
        if (actualIndex === -1) {
          alert('Selected tournament not found.');
          return;
        }
        const selected = tournaments[actualIndex];
        
        if (!selected) {
          alert('Selected tournament not found.');
          return;
        }

        // Check if tournament has admitted players
        const admittedPlayersData = JSON.parse(localStorage.getItem('admittedPlayers') || '{}');
        let hasAdmittedPlayers = false;
        let admittedRoundIds = [];
        
        if (selected.meta && selected.meta.roundIds) {
          selected.meta.roundIds.forEach(roundId => {
            if (admittedPlayersData[roundId] && admittedPlayersData[roundId].length > 0) {
              hasAdmittedPlayers = true;
              admittedRoundIds.push(roundId);
            }
          });
        }

        // Check if tournament has scores
        const scoresData = JSON.parse(localStorage.getItem('scores') || '{}');
        let hasScores = false;
        let scoresRoundIds = [];
        
        if (selected.meta && selected.meta.roundIds) {
          selected.meta.roundIds.forEach(roundId => {
            if (scoresData[roundId] && Object.keys(scoresData[roundId]).length > 0) {
              hasScores = true;
              scoresRoundIds.push(roundId);
            }
          });
        }

        // Check if tournament has draws
        const drawsData = JSON.parse(localStorage.getItem('draws') || '{}');
        let hasDraws = false;
        let drawsRoundIds = [];
        
        if (selected.meta && selected.meta.roundIds) {
          selected.meta.roundIds.forEach(roundId => {
            if (drawsData[roundId]) {
              hasDraws = true;
              drawsRoundIds.push(roundId);
            }
          });
        }

        // If has data, ask to clean up
        if (hasAdmittedPlayers || hasScores || hasDraws) {
          let dataList = [];
          if (hasAdmittedPlayers) dataList.push(`‚Ä¢ Admitted players (${admittedRoundIds.join(', ')})`);
          if (hasScores) dataList.push(`‚Ä¢ Scores (${scoresRoundIds.join(', ')})`);
          if (hasDraws) dataList.push(`‚Ä¢ Draws (${drawsRoundIds.join(', ')})`);
          
          const cleanupConfirm = confirm(
            `This tournament has associated data:\n\n${dataList.join('\n')}\n\n` +
            `Do you want to DELETE all this data and the tournament?\n\n` +
            `Click OK to delete everything, or Cancel to abort.`
          );
          
          if (!cleanupConfirm) {
            return;
          }
          
          // Clean up admitted players
          if (hasAdmittedPlayers) {
            admittedRoundIds.forEach(roundId => {
              delete admittedPlayersData[roundId];
            });
            localStorage.setItem('admittedPlayers', JSON.stringify(admittedPlayersData));
            if (typeof syncToFirebase !== 'undefined' && syncEnabled) {
              syncToFirebase('admittedPlayers', admittedPlayersData);
            }
          }
          
          // Clean up scores
          if (hasScores) {
            scoresRoundIds.forEach(roundId => {
              delete scoresData[roundId];
            });
            localStorage.setItem('scores', JSON.stringify(scoresData));
            if (typeof syncToFirebase !== 'undefined' && syncEnabled) {
              syncToFirebase('scores', scoresData);
            }
          }
          
          // Clean up draws
          if (hasDraws) {
            drawsRoundIds.forEach(roundId => {
              delete drawsData[roundId];
            });
            localStorage.setItem('draws', JSON.stringify(drawsData));
            if (typeof syncToFirebase !== 'undefined' && syncEnabled) {
              syncToFirebase('draws', drawsData);
            }
          }
        } else {
          // No associated data, just confirm deletion
          const tournamentId = selected.tournamentId || '-';
          const displayId = tournamentId.includes('-') ? tournamentId.split('-')[1] : tournamentId;
          const confirmMessage = `Are you sure you want to delete this tournament?\n\nTournament: ${selected.name}\nID: ${displayId}\n\nThis action cannot be undone.`;
          
          if (!confirm(confirmMessage)) {
            return;
          }
        }

        // Delete tournament
        tournaments.splice(actualIndex, 1);
        localStorage.setItem('tournaments', JSON.stringify(tournaments));
        
        // Sync deletion to Firebase
        if (typeof syncToFirebase !== 'undefined' && syncEnabled) {
          syncToFirebase('tournaments', tournaments).then(() => {
            console.log('‚úì Tournament deletion synced to Firebase');
          }).catch(e => console.log('Firebase sync failed:', e));
        }
        
        alert(`‚úÖ Tournament "${selected.name}" has been deleted successfully.`);
        location.reload();
      });
    </script>
  </body>
</html>
